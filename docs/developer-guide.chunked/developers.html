<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>4. Information for developers</title><link rel="stylesheet" type="text/css" href="docbook-xsl.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="home" href="index.html" title="Network UPS Tools Developer Guide" /><link rel="up" href="index.html" title="Network UPS Tools Developer Guide" /><link rel="prev" href="versioning.html" title="3. NUT versioning" /><link rel="next" href="new-drivers.html" title="5. Creating a new driver to support another device" /><meta xmlns="" name="format-detection" content="telephone=no" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left"><a accesskey="p" href="versioning.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="new-drivers.html">Next</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="developers"></a>4. Information for developers</h2></div></div></div><p>This document is intended to explain some of the more useful things
within the tree, and provide a standard for working on the code.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_general_stuff_8201_8212_8201_common_subdirectory"></a>4.1. General stuff — common subdirectory</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_string_handling"></a>String handling</h4></div></div></div><p>Use <code class="literal">snprintf()</code>.  It’s even provided with a compatibility module if the
target system doesn’t have it natively.</p><p>If you use <code class="literal">snprintf()</code> to load some value into a buffer, make sure you
provide the format string.  Don’t use user-provided format strings without
delicate verification, since that’s an easy way to open yourself up to an
exploit.</p><p>Don’t use <code class="literal">strcat()</code>.  We have a neat wrapper for <code class="literal">snprintf()</code> called
<code class="literal">snprintfcat()</code> that allows you to append to <code class="literal">char *</code> with a format
string and all the usual string length checking of <code class="literal">snprintf()</code> routine.
There is also a <code class="literal">vsnprintfcat()</code> (with a single <code class="literal">va_list</code> argument) for
API completeness.</p><p>In a few cases you can use a formatting string coming from a mapping
table or constructed during run-time.  This is generally not safe (due
to references into the stack when handling the variable argument list),
and modern compilers warn against doing so.  While it is possible to
quiesce the warnings with pragmas, it is better to play safe with the
"dynamic" versions of methods provided by NUT — they allow to combine
both compile-time checks of expected formatting string vs. types of data
in the method arguments, and run-time equivalence of the actual dynamic
formatting string to those expectations.  Such hardened methods include
<code class="literal">snprintf_dynamic()</code>, <code class="literal">vsnprintf_dynamic()</code>, <code class="literal">snprintfcat_dynamic()</code>,
<code class="literal">vsnprintfcat_dynamic()</code>, and <code class="literal">mkstr_dynamic()</code> which returns a <code class="literal">char *</code>
to its statically allocated buffer.  Common string operations in drivers
in this case can benefit from similar <code class="literal">dstate_setinfo_dynamic()</code> or
<code class="literal">dstate_addenum_dynamic()</code> methods.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_error_reporting"></a>Error reporting</h4></div></div></div><p>Don’t call <code class="literal">syslog()</code> directly.  Use <code class="literal">upslog_with_errno()</code> and <code class="literal">upslogx()</code>.
They may also write to the <code class="literal">syslog</code>, <code class="literal">stderr</code>, or both as appropriate.
This means you don’t have to worry about whether you’re running in the
background or not.</p><p>The <code class="literal">upslog_with_errno()</code> routine prints your message plus the string
expansion of current <code class="literal">errno</code> value. The <code class="literal">upslogx()</code> just prints the message.</p><p><code class="literal">fatal_with_errno()</code> and <code class="literal">fatalx()</code> work the same way, but they
also <code class="literal">exit(arg)</code> afterwards, where <code class="literal">arg</code> is the first argument of the
<code class="literal">fatal*()</code> method — typically <code class="literal">EXIT_FAILURE</code> or <code class="literal">EXIT_SUCCESS</code>.
In most cases, you should not call <code class="literal">exit()</code> directly.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_debugging_information"></a>Debugging information</h4></div></div></div><p>The <code class="literal">upsdebug_with_errno()</code>, <code class="literal">upsdebugx()</code>, <code class="literal">upsdebug_hex()</code> and
<code class="literal">upsdebug_ascii()</code> routines use the global <code class="literal">nut_debug_level</code>, so you
don’t have to mess around with <code class="literal">printf()</code>'s and <code class="literal">if</code>'s yourself.
Use them.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_memory_allocation"></a>Memory allocation</h4></div></div></div><p><code class="literal">xmalloc()</code>, <code class="literal">xcalloc()</code>, <code class="literal">xrealloc()</code> and <code class="literal">xstrdup()</code> all check the
results of the base calls before continuing, so you don’t have to.
Don’t use the raw calls directly.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_config_file_parsing"></a>Config file parsing</h4></div></div></div><p>The configuration parser, called <code class="literal">parseconf</code>, is now up to its fourth
major version.  It has multiple entry points, and can handle many
different jobs.  It’s usually used for parsing files, but it can also
take input a line at a time or even a character at a time.</p><p>You must initialize a context buffer with <code class="literal">pconf_init()</code> before using any
other <code class="literal">parseconf</code> function.  <code class="literal">pconf_encode()</code> is the only exception, since
it operates on a buffer you supply and is an auxiliary function.</p><p>Escaping special characters and quoting multiple-word elements is all
handled by the state machine.  Using the same code for all config files
avoids code duplication.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>this does not apply to drivers.  Driver authors should use the
<code class="literal">upsdrv_makevartable()</code> scheme to pick up values from <span class="emphasis"><em>ups.conf</em></span> file.
Drivers should not have their own config files.</p></div><p>Drivers may have their own data files, such as lists of hardware,
mapping tables, or similar.  The difference between a data file and a
config file is that users should never be expected to edit a data file
under normal circumstances.  This technique might be used to add more
hardware support to a driver without recompiling.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_lt_time_h_gt_vs_lt_sys_time_h_gt"></a>&lt;time.h&gt; vs. &lt;sys/time.h&gt;</h4></div></div></div><p>This is already handled by autoconf, so just <code class="literal">#include "timehead.h"</code> and
you will get the right headers on every system.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_device_drivers_8201_8212_8201_main_c"></a>4.2. Device drivers — main.c</h3></div></div></div><p>The device drivers use <code class="literal">main.c</code> as their core.</p><p>To write a new driver, you create a file with a series of support
functions that will be called by main.  These all have names that start
with <code class="literal">upsdrv_</code>, and they will be called at different times by main
depending on what needs to happen.</p><p>See the <a class="link" href="new-drivers.html" title="5. Creating a new driver to support another device">driver documentation</a> for information on writing
drivers, and also refer to the skeletal driver in <code class="literal">skel.c</code>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_portability"></a>4.3. Portability</h3></div></div></div><p>Avoid things that will break on other systems.  All the world is not an
x86 Linux box.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_c_comments"></a>C comments</h4></div></div></div><p>There are still older systems out there that don’t do C++ style comments.</p><pre class="screen">/* Comments look like this. */
// Not like this.</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_complete_method_signatures"></a>Complete method signatures</h4></div></div></div><p>If a method has intentionally no arguments, this should be explicit by
specifying a <code class="literal">void</code> argument list in both declarations (header or top
of a C source file for <code class="literal">static</code> methods) and implementations:</p><pre class="screen">/* Like this: */
void good_stuff(void);

/* NOT like this: */
void bad_stuff();</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_variable_declarations_go_on_top"></a>Variable declarations go on top</h4></div></div></div><p>Newer versions of gcc allow you to declare a variable inside a function
after code, somewhat like the way C++ operates, like this:</p><pre class="screen">function do_stuff(void)
{
        check_something();

        int a;

        a = do_something_else();
}</pre><p>While this will compile and run on these newer versions, it will fail
miserably for anyone on an older system.  That means you must not use it.</p><p>Note that <code class="literal">gcc</code> only warns about this with <code class="literal">-pedantic</code> flag, and <code class="literal">clang</code>
with a <code class="literal">-Weverything</code> (possibly <code class="literal">-Wextra</code>) flag, which can be enabled by
developers with <code class="literal">configure --enable-warnings=...</code> option values (and made
fatal with <code class="literal">configure --enable-Werror</code>), to ensure non-regression of code
quality.  It was reported that <code class="literal">clang-16</code> with such options does complain
about non-portability to older C language revisions even if explicitly
building for a newer revision.</p><p>Please note that for the purposes of legacy-compatible variable declarations
(on top of their scopes), a <code class="literal">NUT_UNUSED_VARIABLE(varname)</code> counts as code and
should be used just below the declarations.  Initial assignments to variables
(also as return values of methods) may generally happen as part of their
declarations.</p><p>You can use scoping (e.g. <code class="literal">do { ... } while (0);</code>) where it makes sense
to constrain visibility of temporary variables, such as in <code class="literal">switch/case</code>
blocks.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_variable_declaration_in_loop_block_syntax"></a>Variable declaration in loop block syntax</h4></div></div></div><p>Another feature that does not work on some compilers (e.g. conforming
to "ANSI C"/C89/C90 standard) is initial variable declaration inside a
<span class="emphasis"><em>for loop</em></span> block, like this:</p><pre class="screen">function do_stuff(void)
{
        /* This should declare "int i;" first, then use it in "for" loop: */
        for (int i = 0; i &lt; INT_MAX; ++i) { ... }

        /* Additional loops cause also an error about re-declaring a variable: */
        for (int i = 10; i &lt; 15; ++i) { ... }
}</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_variable_length_arrays"></a>Variable length arrays</h4></div></div></div><p>We also avoid initialization of arrays using a variable (e.g. a method
argument) as poorly portable to older compilers, and prefer explicitly
allocated and freed buffers, if variable size is needed.</p><p>This should be avoided:</p><pre class="screen">function avoid_vla(int len)
{
        char    *buf[len];
...
}</pre><p>This should be used instead (preferably with <code class="literal">size_t</code> arguments right away),
be sure to <code class="literal">free()</code> anywhere you <code class="literal">return</code> from the function:</p><pre class="screen">int use_xcalloc(size_t len)
{
        char    *buf = xcalloc(len, sizeof(char));

        if (!buf)
                return -1;
...
        free(buf);
        return 1;
}</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_other_hints"></a>Other hints</h4></div></div></div><div class="tip" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Tip</h3><p>At this point NUT is expected to work correctly when built with a
"strict" C99 (or rather GNU99 on many systems) or newer standard.</p></div><p>The NUT codebase may build in a mode without warnings made fatal on C89
(GNU89), but the emitted warnings indicate that those binaries may crash.
By the end of 2021, NUT codebase has been revised to pass GNU and strict-C
mode builds with C89 standard with the GCC toolkit (and on systems that do
have the newer features in libraries, just hide them in standard headers);
however CLANG toolkit is more restrictive about the C99+ syntax used.
That said, some systems refuse to expose methods or types available in
their system headers and binary libraries if strict-C mode is used alone,
without extra system-specific defines to enable more than the baseline.</p><p>It was also seen that cross-builds (e.g. NUT for Windows using mingw on
Linux) may be unable to define <code class="literal">WIN32</code> and/or find symbols for linking
when using a strict-C language standard.</p><p>The C++ support expects C+<code class="literal">11 or newer (not really configured or tested
for older C</code>+98 or C+<code class="literal">03), modulo features that were deprecated in later
language revisions (C</code>+14 onwards) as highlighted by warnings from newer
compilers.</p><p>Note also that the NUT codebase currently relies on certain features,
such as the printf format modifiers for <code class="literal">(s)size_t</code>, use of <code class="literal">long long</code>,
some nuances about structure/array initializers, variadic macros for
debugging, etc. that a pedantic C90 mode compilation warns is not part
of the standard but a GNU extension (and part of C99 and newer standard
revisions). Many of the "offences" against the older standard actually
come from system and third-party header files.</p><p>That said, the NUT CI farm does run non-regression builds with GNU C89
and "strict" C89 standard revisions and minimal passing warnings level,
to ensure that codebase is and remains at least basically compliant.
We try to cover a few distributions from early 2000’s for this, either
in regular CI builds or one-off local builds for community members with
a zoo of old systems.</p><p>If somebody in the community actually requires to build and run NUT on
systems that old, where newer compilers are not available, pull requests
to fix the offending coding issues in some way that does not break other
use-cases are welcome.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_continuous_integration_and_automated_builds"></a>4.4. Continuous Integration and Automated Builds</h3></div></div></div><p>To ease and automate the build scenarios which were deemed important for
quality assurance and non-regression checks of NUT, several solutions
were introduced over time.</p><p>For more information, and perhaps inspiration for building a similar
solution, please see the <span class="strong"><strong>NUT Quality Assurance and Build Automation Guide</strong></span>,
and specifically its chapters on
<a class="ulink" href="../qa-guide.chunked/index.html#CI_compiler_warnings" target="_top">Static analysis by compilers</a>,
<a class="ulink" href="../qa-guide.chunked/index.html#CI_BUILD_SH" target="_top">ci_build.sh script</a> (or <code class="code">ci_build.adoc</code> in NUT sources for up-to-date information),
<a class="ulink" href="../qa-guide.chunked/index.html#NUTCI_farm_technologies" target="_top">Continuous Integration (NUT CI farm) technologies</a> and
<a class="ulink" href="../qa-guide.chunked/index.html#NUTCI_farm_agents" target="_top">Continuous Integration (NUT CI farm) build agent preparation</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_integrated_development_environments_ides_and_debugging_nut"></a>4.5. Integrated Development Environments (IDEs) and debugging NUT</h3></div></div></div><p>Much of NUT has been coded using classic editors of developers' preference,
like <code class="literal">vi</code>, <code class="literal">nano</code>, Midnight Commander <code class="literal">mcedit</code>, <code class="literal">gedit</code>/<code class="literal">pluma</code>, NotePad++
and tools like <code class="literal">meld</code> or WinMerge for file comparison and merge.</p><p>Modern IDEs however do offer benefits, specifically for live debugging
sessions in a more convenient fashion than with command-line <code class="literal">gdb</code> directly.
They also simplify writing AsciiDoc files with real-time rendering support.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>Due to use of <code class="literal">libtool</code> wrappers in "autotools" driven projects,
it may be tricky to attach the debugger (mixing the correct <code class="literal">LD_LIBRARY_PATH</code>
or equivalent with a binary under a <code class="literal">.libs</code> subdirectory; on some platforms
you may be better off copying shared objects to the directory with the binary
being tested).</p></div><p>IDEs that were tested to work with NUT development and real-time debugger
tracing include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Sun NetBeans 8.2 on Solaris, Linux (including local and remote build
  and debug ability);
</li><li class="listitem">
Apache NetBeans 17 on Windows with MSYS2 support (as MinGW toolkit);
</li><li class="listitem">
Visual Studio Code (VSCode) on Windows with MSYS2 support.
</li></ul></div><p>Some supporting maintenance and development is doable with IntelliJ IDEA,
making some things easier to do than with a simple Notepad, but it does
not handle C/C++ development as such.</p><p>Take note that some IDEs can store their project data in the source root
directory of a project (such as NUT codebase). While <code class="literal">.gitignore</code> rules
can take care of not adding your local configuration into the SCM, these
locations can be wiped by a careless <code class="literal">git clean -fdX</code>. You are advised
to explore configuring your IDE to store project configurations outside
the source codebase location, or to track such subdirectories as <code class="literal">nbproject</code>
or <code class="literal">nb-cache</code> or <code class="literal">.idea</code> as a separate Git repository (not necessarily a
submodule of NUT nor really diligently tracked) to avoid such surprises.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_ide_notes_on_windows"></a>IDE notes on Windows</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="_general_settings_for_builds_on_windows"></a>General settings for builds on Windows</h5></div></div></div><p>When working in a native Windows environment with
<a class="ulink" href="https://www.msys2.org/" target="_top">MSYS2</a> (providing MinGW x64 among other things),
you may need to ensure certain environment variables are set before you start
the IDE (shortcuts and wrappers that start your console apply them via shell).</p><div class="warning" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Warning</h3><p>If you set such environment variables system-wide for your user
profile (or wrap the IDE start-up by a script to set them), it may compromise
your ability to use <span class="strong"><strong>other</strong></span> MSYS2 profiles and/or other builds of these
toolkits (packaged by e.g. Git for Windows or PERL for Windows projects)
generally, or in the same IDE session, respectively.
You may want to do this in a dedicated user account!</p></div><p>Examples below assume you installed MSYS2 into <code class="literal">C:\msys64</code> (by default) and
are using the "MinGW X64" profile for GCC builds (nuances may differ for
32-bit, CLANG, UCRT and other profile variants).</p><p>Also keep in mind that not all dependencies and tools involved in a
fully-fledged NUT build are easily available or usable on Windows (e.g.
the spell checker). See <a class="ulink" href="../qa-guide.chunked/index.html#NUT_Config_Prereqs" target="_top">Prerequisites for building NUT on different OSes</a> (or <code class="code">docs/config-prereqs.txt</code> in NUT sources for up-to-date information) for better detailed
package lists for different operating systems including Windows, and feel
welcome to post pull requests with suggestions about new tool-chains that
might fare better than those already tried and documented.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
Make sure its tools are in the <code class="literal">PATH</code>:
</p><p class="simpara">Control Panel ⇒ "Edit the system environment variables" ⇒
  "Environment variables…" (button) ⇒
  "Edit…" or create "New…" <code class="literal">Path</code> setting ("User variable" level suffices) ⇒</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Make sure <code class="literal">C:\msys64\mingw64\bin</code> and <code class="literal">C:\msys64\usr\bin</code> are both there.
</li><li class="listitem">
Depending on further installed toolkits, you may want to add
   <code class="literal">C:\Program Files\Git\cmd</code> or <code class="literal">C:\Program Files\Microsoft VS Code\bin</code>
   (preferably use deployment-dependent spellings without white-space like
   <code class="literal">Progra~1</code> to err on the safe side of variable expansions later).
</li></ul></div></li><li class="listitem"><p class="simpara">
Make sure that MSYS2 (and tools which integrate with it) know its home:
</p><p class="simpara">Open Environment variables window as above, and
  "Edit…" or create "New…" <code class="literal">MSYS_HOME</code> setting ⇒
  Set to <code class="literal">C:\msys64\mingw64\bin</code>
* Restart the IDE (if already running) for it to acknowledge the system
  configuration change.</p></li></ul></div><p>Otherwise, NetBeans for example claims there is no shell for it to run <code class="literal">make</code>
or open Terminal pane windows, and fails to start the built programs due to
lack of DLL files they were linked against (such as <code class="literal">libssl</code> usually needed
for any networked part of the codebase).</p><p>You might still have to fiddle with DLL files built in other directories of
the NUT project, when preparing to debug certain programs, e.g. for <code class="literal">dummy-ups</code>
testing you may need to:</p><pre class="screen">:; cp ./clients/.libs/libupsclient-6.dll ./drivers/.libs/</pre><p>To ensure builds with debug symbols, you may add <code class="literal">CFLAGS</code> and <code class="literal">CXXFLAGS</code> set
to <code class="literal">-g3 -gdwarf-2</code> or similar to <code class="literal">configure</code> options, or if that confuses
the cross-build (it tends to assume those values are part of GCC path),
you may have to hack them into your local copy of <code class="literal">configure.ac</code>, after the
<code class="literal">AM_INIT_AUTOMAKE([subdir-objects])</code> line:</p><pre class="screen">CFLAGS="$CFLAGS -g3 -gdwarf-2"
CXXFLAGS="$CXXFLAGS -g3 -gdwarf-2"</pre><p>…and re-run the <code class="literal">./autogen.sh</code> script.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="_gdb_on_windows"></a>GDB on Windows</h5></div></div></div><p>Examples below assume that whichever IDE you are using, the primary goal is
to debug some issues with NUT on that platform.</p><p>This may require you to craft a configuration file for the GNU Debugger,
e.g. <code class="literal">C:\Users\abuild\.gdbinit</code> for the examples below. One is not required
however, and may be missing.</p><p>Another thing to keep in mind is that with <code class="literal">libtool</code> involved, the actual
binary for testing would be in a <code class="literal">.libs</code> subdirectory and you may have some
fun with ensuring that DLLs are found to start them — see the notes above.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="_netbeans_on_windows"></a>NetBeans on Windows</h5></div></div></div><p>When you install newer <a class="ulink" href="https://netbeans.apache.org/" target="_top">Apache NetBeans</a>
releases (14, 17 as of this writing), you may need to enable the use of
"NetBeans 8.2 Plugin Portal" (check under Tools/Plugins/Settings) and
install the "C/C++" plugin only available there at the moment.
In turn, that older build of a plugin package may require that your system
provides the <code class="literal">unpack200(.exe)</code> tool which was shipped with JDK11 or older
(you may have to install that just to get the tool, or copy its binary from
another system).</p><p>Under Tools/Options menu open the C/C++ tab and further its Build Tools sub-tab.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>NetBeans allows you to easily define different Tool Collections,
including those associated with a different build host (accessible over SSH
and source/build paths optionally shared over NFS or similar technology, or
copied over). This allows you to run the IDE on your desktop while debugging
a build running on a server or embedded system.</p></div><p>Make sure you have a MinGW Tool Collection for the "localhost" build host with
such settings as:</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Option name</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Sample value</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Family</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>GNU MinGW</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Encoding</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>UTF-8</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Base Directory</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\bin</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>C Compiler</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\bin\gcc.exe</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>C++ Compiler</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\bin\g++.exe</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Assembler</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\bin\as.exe</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Make Command</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\usr\bin\make.exe</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>Debugger Command</p></td><td style="" align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\bin\gdb.exe</code></p></td></tr></tbody></table></div><p>In the Code Assistance sub-tab check that there are toolkit-specific and
general include paths, e.g. both C and C++ Compiler settings might involve:</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /></colgroup><tbody><tr><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\lib\gcc\x86_64-w64-mingw32\12.2.0\include</code></p></td></tr><tr><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\include</code></p></td></tr><tr><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\lib\gcc\x86_64-w64-mingw32\12.2.0\include-fixed</code></p></td></tr><tr><td style="" align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\x86_64-w64-mingw32\include</code></p></td></tr></tbody></table></div><p>On top of that, C++ Compiler settings may include:</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /></colgroup><tbody><tr><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\include\12.2.0</code></p></td></tr><tr><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\include\12.2.0\x86_64-w64-mingw32</code></p></td></tr><tr><td style="" align="left" valign="top"><p><code class="literal">C:\msys64\mingw64\include\12.2.0\backward</code></p></td></tr></tbody></table></div><p>In the "Other" sub-tab, set default standards to C99 and C++11 to match common
NUT codebase expectations.</p><p>Finally, open/create a "nut" project pointing to your git checkout workspace.</p><p>Next part of configuration regards build/debug configurations, which you can
find on the toolbar or as File / Project Properties.</p><p>The main configuration for debugging a particular binary (and NUT has tons
of those, good luck in case you want to debug several simultaneously) is
in the <span class="strong"><strong>Run</strong></span> and <span class="strong"><strong>Debug</strong></span> categories. You may want to define different
Configuration profiles to track the individual Run/Debug settings for
different tested binaries, while the Build/Make settings would remain the same.
Alternatively, you may set the <span class="strong"><strong>Make</strong></span> category’s "Build Result" as the path to
the binary you would test, and use <code class="literal">${OUTPUT_PATH}</code> variable as its name in
the "Run Command" (still likely need custom arguments) and "Symbol File" below.</p><p>When you investigate interactions of two or more programs, but only want to
debug (step through) just one of them, you are advised to run each of the
others from a dedicated terminal session, and just bump their debug verbosity.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
In the <span class="strong"><strong>Build</strong></span> category, set the Build Host (localhost) and Tool Collection
  (MinGW). In expert part of the settings, un-check "platform-independent"
  and revise that the <code class="literal">TOOLS_PATH=C:\msys64\mingw64\bin</code> while the
  <code class="literal">UTILITIES_PATH=C:\msys64\usr\bin</code>.
</li><li class="listitem"><p class="simpara">
In the <span class="strong"><strong>Pre-Build</strong></span> category likely keep the Working Directory as <code class="literal">.</code> and
  the <code class="literal">Pre-Build First</code> generally unchecked (so only enable it to reconfigure
  the project, which takes time and is not needed for every rebuild iteration),
  but you may still pre-set the Command line to something like the following
  (on one line):
</p><pre class="screen">bash -c "rm -f configure Makefile; ./autogen.sh &amp;&amp;
    ./configure CC='${IDE_CC}' CXX='${IDE_CXX}'
        --with-all=auto --with-docs=skip"</pre><p class="simpara">In some cases, NOT specifying the <code class="literal">CC</code>, <code class="literal">CXX</code> and the flags actually succeeds
while passing their options fails the configuration ("Compiler can not create
executables" etc.) probably due to path resolution issues between the native
and MinGW environments.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>In practice, you may have an easier time using NUT <code class="literal">./ci_build.sh</code> helper or
running a more specific <code class="literal">./autogen.sh &amp;&amp; ./configure ...</code> spell similar to
the above example or customized otherwise, in the MinGW x64 console window
to actually configure a NUT source code setup, than to maintain one via the IDE.
Running (re-)builds with the IDE (as you just edit non-recipe sources and
iterate with a debugger) using externally configured Makefiles works fine.</p></div></li><li class="listitem"><p class="simpara">
In the <span class="strong"><strong>Make</strong></span> category you may want to customize for parallelized builds on
  multi-CPU systems with something like:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Build Command: <code class="literal">${MAKE} -j 6 -f Makefile</code>
</li><li class="listitem">
Clean Command: <code class="literal">${MAKE} -f Makefile clean</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
In the <span class="strong"><strong>Run</strong></span> category you should set the "Run Command" to point to your
  binary (note the <code class="literal">.libs</code> sub-directory, and see comments above regarding
  possibly needed copies of shared objects) and its arguments (all on one
  line), e.g.:
</p><pre class="screen">C:\Users\abuild\Desktop\nut\drivers\.libs\usbhid-ups.exe -s ups -x port=auto
    -d1 -DDDDDD</pre><p class="simpara">Other useful settings may be to keep "Build First" checked, and if the
"Internal Terminal" does not work for you as the debugged program’s console — set the "Console Type" to "External Terminal" of type "Command Window".
Unfortunately, NetBeans on Windows may have issues running terminal tabs
unless CygWin is installed.</p></li><li class="listitem">
In the <span class="strong"><strong>Debug</strong></span> category you should set the "Symbol File" to point to your
  tested binary (e.g. <code class="literal">C:\Users\abuild\Desktop\nut\drivers\.libs\usbhid-ups.exe</code>
  to match the "Run Command" example above) and specify "Follow Fork Mode" as
  "child" and "Detach On Fork" as "off". "Reverse Debugging" may be useful too
  in some situations. Finally, select your "Gdb Init File" if you have one,
  e.g. <code class="literal">C:\Users\abuild\.gdbinit</code>.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="_microsoft_vs_code"></a>Microsoft VS Code</h5></div></div></div><p>With this IDE you can benefit from numerous Extensions from its Marketplace,
the ones found useful for NUT development and debugging include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
AsciiDoc (by asciidoctor)
</li><li class="listitem">
EditorConfig for VS Code (by EditorConfig)
</li><li class="listitem">
C/C++ (by Microsoft)
</li><li class="listitem">
C/C++ Extension pack (by Microsoft)
</li><li class="listitem">
Makefile tool (by Microsoft)
</li><li class="listitem">
MSYS2/Cygwin/MinGW/Clang support (by okhlybov)
</li><li class="listitem">
Native Debug (GDB, LLDB … Debugger support; by WebFreak)
</li></ul></div><p>Configurations are tracked locally in JSON files where you would need to add
some entries. Examples below highlight the needed keys and values; your files
may have others:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
<code class="literal">.vscode/launch.json</code> (can create one via Run/Add Configuration… menu
  defines ways to launch the debug session for a program:
</p><pre class="screen">{
    "configurations": [
        {
            "name": "CPPDBG GDB usbhid-ups",
            "type": "cppdbg",
            "request": "launch",
            "program": "C:\\Users\\abuild\\Desktop\\nut\\drivers\\.libs\\usbhid-ups.exe",
            "additionalSOLibSearchPath": "C:\\Users\\abuild\\Desktop\\nut\\.inst\\mingw64\\bin",
            "stopAtConnect": true,
            "args": ["-s", "ups", "-DDDDDD", "-d1", "-x", "port=auto"],
            "stopAtEntry": false,
            "cwd": "C:\\Users\\abuild\\Desktop\\nut",
            "environment": [],
            "externalConsole": false,
            "MIMode": "gdb",
            "miDebuggerPath": "C:\\msys64\\mingw64\\bin\\gdb.exe",
            "targetArchitecture": "x64",
            "setupCommands": [
                {
                    "description": "Enable pretty-printing for gdb",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                },
                {
                    "description": "Set Disassembly Flavor to Intel",
                    "text": "-gdb-set disassembly-flavor intel",
                    "ignoreFailures": true
                }
            ],
            "preLaunchTask": "make usbhid-ups"
        },
        {
            // Alternately with LLDB (clang), the rest looks like above:
            "name": "CPPDBG LLDB usbhid-ups",
            "MIMode": "lldb",
            "miDebuggerPath": "C:\\msys64\\usr\\bin\\lldb.exe",
        },
        ...
    ]
}</pre></li><li class="listitem"><p class="simpara">
<code class="literal">.vscode/tasks.json</code> defines other tasks, such as the <code class="literal">preLaunchTask</code>
  mentioned above (assuming you have configured the build externally in
  the MinGW x64 terminal session):
</p><pre class="screen">{
    "tasks": [
        {
            "type": "shell",
            "label": "make usbhid-ups",
            "command": "C:\\msys64\\usr\\bin\\make usbhid-ups",
            "options": {
                "cwd": "${workspaceFolder}/drivers"
            },
            "problemMatcher": [
                "$gcc"
            ],
            "group": {
                "kind": "build",
                "isDefault": true
            }
        },
        ...
    ]
}</pre></li><li class="listitem"><p class="simpara">
<code class="literal">.vscode/c_cpp_properties.json</code> defines general compiler settings, e.g.:
</p><pre class="screen">{
    "configurations": [
        {
            "name": "Win32",
            "includePath": [
                "${workspaceFolder}/**",
                "C:\\msys64\\mingw64\\include\\libusb-1.0",
                "C:\\msys64\\mingw64\\include",
                "C:\\msys64\\usr\\include"
            ],
            "defines": [
                "_DEBUG",
                "UNICODE",
                "_UNICODE"
            ],
            "compilerPath": "C:\\msys64\\mingw64\\bin\\gcc.exe",
            "cStandard": "c99",
            "cppStandard": "c++11",
            "intelliSenseMode": "windows-gcc-x64",
            "configurationProvider": "ms-vscode.makefile-tools"
        }
    ],
    "version": 4
}</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="_intellij_idea"></a>IntelliJ IDEA</h5></div></div></div><p>It is worth mentioning IntelliJ IDEA as another free (as of Community Edition)
and popular IDE, however it is of limited use for NUT development.</p><p>Its ecosystem does feature a good AsciiDoc plugin, Python and of course the
Java/Groovy support, so IDEA is helpful for maintenance of NUT documentation,
helper scripts and CI recipes.</p><p>It lacks however C/C++ language support (allegedly a different product in the
IntelliJ portfolio is dedicated to that), so for the core NUT project sources
it is just a fancy text editor (with <code class="literal">.editorconfig</code> support) without syntax
highlighting or codebase cross-reference aids, build/run/debug support, etc.</p><p>Still, it is possible to run builds and tests in embedded or external terminal
session — so it is not worse than editing with legacy tools, and navigation
or code-base-wide search is arguably easier.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_coding_style"></a>4.6. Coding style</h3></div></div></div><p>This is how we do things:</p><pre class="screen">int open_subspace(char *ship, int privacy)
{
        if (!privacy)
                return insecure_channel(ship);

        if (!init_privacy(ship))
                fatal_with_errno("Can't open secure channel");

        return secure_channel(ship);
}</pre><p>The basic idea is that we try to group things into functions, and then
find ways to drop out of them when we can’t go any further.  There’s
another way to program this involving a big else chunk and a bunch of
braces, and it can be hard to follow.  You can read this from top to
bottom and have a pretty good idea of what’s going on without having to
track too much <code class="literal">{ }</code> nesting and indenting.</p><p>We don’t really care for <code class="literal">pretentiousVariableNamingSchemes</code>, but you can
probably get away with it in your own driver that we will never have to
touch.  If your function or variable names start pushing important code
off the right margin of the screen, expect them to meet the byte
chainsaw sooner or later.</p><p>All types defined with <code class="literal">typedef</code> should end in <code class="literal">_t</code>, because this is
easier to read, and it enables tools (such as <code class="literal">indent</code> and <code class="literal">emacs</code>) to
display the source code correctly.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_indenting_with_tabs_vs_spaces"></a>Indenting with tabs vs. spaces</h4></div></div></div><p>Another thing to notice is that the indenting happens with tabs instead
of spaces.  This lets everyone have their personal tab-width setting
without inflicting much pain on other developers.  If you use a space,
then you’ve fixed the spacing in stone and have really annoyed half of
the people out there.</p><p>Note that tabs apply only to <span class="strong"><strong>indenting</strong></span>.  Alignment of text after any
non-tab character has appeared on the line must be done by spaces in
order for it to remain at the same alignment when someone views tabs at
a different widths.</p><p>One common example for this is multi-line if condition:</p><pre class="screen">        if (something &amp;&amp;
            something_else) {</pre><p>which may be written without mixing tabs and spaces to indent, as:</p><pre class="screen">        if (something
        &amp;&amp;  something_else
        ) {</pre><p>Another example is tables of definitions that are better aligned with
(non-leading) spaces at least between names and values not too many
characters wide; it still helps to align the columns with spaces at
offsets divisible by 4 or 8 (consistently for the whole table):</p><pre class="screen">#define SHORT_MACRO                         1   /* flag comment */
#define SOMETHING_WITH_A_VERY_LONG_NAME     255 /* flag comment */</pre><p>While at it, we encourage indentation of nested preprocessor macros
and pragmas, by adding a single space character for each inner level,
as well as commenting the <code class="literal">#else</code> and <code class="literal">#endif</code> parts (especially if
they are far away from their opening <code class="literal">#if</code>/<code class="literal">#ifdef</code>/<code class="literal">#ifndef</code> statement)
to help visual navigation in the source code base. Please take care to
keep the hash <code class="literal">#</code> character of the preprocessor lines in the left-most
column, since some implementations of <code class="literal">cpp</code> parser used for analysis
default to "traditional" (pre-C89) syntax shared with other languages,
and then ignore lines which do not start with the hash character (or
worse, ignore only some of them but not others).</p><pre class="screen">#ifdef WITH_SSL
# ifdef WITH_NSS
        /* some code for NSS */
# endif /* WITH_NSS */
# ifdef WITH_OPENSSL
#  ifndef WIN32
        /* some code for OpenSSL on POSIX systems */
#  else /* not WIN32 */
        /* some code for OpenSSL on Windows */
#  endif        /* not WIN32 */
# endif /* WITH_OPENSSL */
#else   /* not WITH_SSL */
        /* report that crypto support is not built */
#endif  /* WITH_SSL */</pre><p>If you write something that uses leading spaces, you may get away with
it in a driver that’s relatively secluded.  However, if we have to work
on that code, expect it to get reformatted according to the above.</p><p>Patches to existing code that don’t conform to the coding style being
used in that file will probably be dropped.  If it’s something we really
need, it will be grudgingly reformatted before being included.</p><p>When in doubt, have a look at Linus’s take on this topic in the Linux
kernel — <a class="ulink" href="https://github.com/torvalds/linux/blob/master/Documentation/process/coding-style.rst" target="_top">Documentation/CodingStyle</a>.
He’s done a far better job of explaining this.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_line_breaks"></a>Line breaks</h4></div></div></div><p>It is better to have lines that are longer than 80 characters than to
wrap lines in random places. This makes it easier to work with tools
such as <code class="literal">grep</code>, and it also lets each developer choose their own
window size and tab setting without being stuck to one particular
choice.</p><p>Of course, this does not mean that lines should be made unnecessarily
long when there is a better alternative (see the note on
<code class="literal">pretentiousVariableNamingSchemes</code> above).  Certainly there should not
be more than one statement per line. Please do not use</p><pre class="screen">if (condition) break;</pre><p>but use the following:</p><pre class="screen">if (condition) {
        break;
}</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>Earlier revisions of coding style might suggest avoiding braces if just
one line is added as condition/loop/etc. handling code. Current approach is to
welcome them even for single lines: on one hand, this confirms the intention
that only this line is the conditional code; on another, this minimizes the
context differences for later code comparisons, relocation, refactoring, etc.</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_un_used_variables_and_function_arguments"></a>Un-used variables and function arguments</h4></div></div></div><p>Whenever a function needs to satisfy a particular API, it can end up
taking arguments that are not used in practice (think a too-trivial
signal handler). While some compilers offer the facility of decorations
like <code class="literal">__attribute__(unused)</code>, this proved not to be a portable solution.
Also the abilities of newer C/C++ standard revisions are of no help to
the vast range of existing systems that run NUT today and expect to be
able to do so tomorrow (hence the required C99+ support noted above).</p><p>In NUT codebase we prefer to mark un-used variables explicitly in the
body of the function (or an <code class="literal">#ifdef</code> branch of its code) using the
<code class="literal">NUT_UNUSED_VARIABLE(varname)</code> as a routine call inside a function
body, referring to the macro defined in <code class="literal">common.h</code>.</p><p>Please note that for the purposes of legacy-compatible variable declarations
(on top of their scopes), <code class="literal">NUT_UNUSED_VARIABLE(varname)</code> counts as code and
should happen below the declarations.</p><p>To display in a rough example:</p><pre class="screen">        static void signal_X_handler(int signal_X) {
                NUT_UNUSED_VARIABLE(signal_X);
                /* We have explicitly got nothing to do if we catch signal X */
                return;
        }</pre><p>All this having been said, we do detect and use the support for pragmas
to quiesce the complaints about such situations, but limit their use to
processing of certain third-party header files.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_miscellaneous_coding_style_tools"></a>4.7. Miscellaneous coding style tools</h3></div></div></div><p>NUT codebase includes an <code class="literal">.editorconfig</code> file which should be supported
by most of the IDEs and text editors nowadays. Many support this format
specification (at least partially) out of the box, possibly with some
configuration toggle in the GUI. Others may need a plugin, see more at
<a class="ulink" href="https://editorconfig.org/#pre-installed" target="_top">https://editorconfig.org/#pre-installed</a> page. There are also command-line
tools to verify and/or enforce compliance of source files to configuration.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>A long-standing plan is to define a <code class="literal">clang-format</code> specification
for all the different nuances like where we do and don’t want spaces
around parentheses, how to align multi-line conditional expressions, etc.
in a way that most of the current NUT code base would already conform.
Taking the first step is the hardest part, so PRs are welcome :)</p></div><p>You can go a long way towards converting your source code to the NUT
coding style by piping it through the following command:</p><pre class="literallayout">:; indent -kr -i8 -T FILE -l1000 -nhnl</pre><p>This next command does a reasonable job of converting most C++ style
comments (but not URLs and DOCTYPE strings):</p><pre class="literallayout">:; sed 's#\(^\|[ \t]\)//[ \t]*\(.*\)[ \t]*#/* \2 */#'</pre><p>Emacs users can adjust how tabs are displayed. For example, it is
possible to set a tab stop to be 3 spaces, rather than the usual 8.
(Note that in the saved file, one indentation level will still
correspond to one tab stop; the difference is only how the file is
rendered on screen). It is even possible to set this on a
per-directory basis, by putting something like this into your <code class="literal">.emacs</code>
file:</p><pre class="screen">;; NUT style

(defun nut-c-mode ()
 "C mode with adjusted defaults for use with the NUT sources."
 (interactive)
 (c-mode)
 (c-set-style "K&amp;R")
 (setq c-basic-offset 3)  ;; 3 spaces C-indentation
 (setq tab-width 3))      ;; 3 spaces per tab

;; apply NUT style to all C source files in all subdirectories of nut/

(setq auto-mode-alist (cons '(".*/nut/.*\\.[ch]$". nut-c-mode)
                       auto-mode-alist))</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_finishing_touches"></a>Finishing touches</h4></div></div></div><p>We like code that uses <code class="literal">const</code> and <code class="literal">static</code> liberally.  If you don’t need
to expose a function or global variable to the outside world, <code class="literal">static</code> is
your friend.  If nobody should edit the contents of some buffer that’s
behind a pointer, <code class="literal">const</code> keeps them honest.</p><p>We always compile with <code class="literal">-Wall</code>, so things like <code class="literal">const</code> and <code class="literal">static</code> help you
find implementation flaws.  Functions that attempt to modify a constant
or access something outside their scope will throw a warning or even
fail to compile in some cases.  This is what we want.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_switch_case_vs_default_vs_enum"></a>Switch case vs. default vs. enum</h4></div></div></div><p>NUT codebase often uses the <code class="literal">switch/case/case.../default</code> construct to handle
conditional situations expressed by discrete numeric values (the <code class="literal">case value:</code>
labels). Different compilers and their different warning settings require
different rules to be satisfied, and those are sometimes at odds:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
a <code class="literal">switch</code> should definitively handle all cases, so must have a <code class="literal">default</code>
  label — this works well for general numeric variables;
</li><li class="listitem">
an <code class="literal">enum</code>'s valid values are known at compile time, and each must be handled
  explicitly (even if implemented as many <code class="literal">case value:</code> labels preceding the
  same code block), so…
</li><li class="listitem">
…a <code class="literal">default</code> label is redundant (should never be reachable) in a <code class="literal">switch</code>
  that handles all <code class="literal">enum</code> values — but this notion is a head-on crash vs. the
  first rule above.
</li></ul></div><p>Ultimately, some cases require the wall of <code class="literal">pragma</code> directives below against
warnings at this spot, and we use the <code class="literal">default</code> label handling to be sure,
as the least-worst solution (ultra-long lines wrapped for readability in this
document):</p><pre class="screen">#if (defined HAVE_PRAGMA_GCC_DIAGNOSTIC_PUSH_POP) \
 &amp;&amp; ( (defined HAVE_PRAGMA_GCC_DIAGNOSTIC_IGNORED_COVERED_SWITCH_DEFAULT) \
   || (defined HAVE_PRAGMA_GCC_DIAGNOSTIC_IGNORED_UNREACHABLE_CODE) )
# pragma GCC diagnostic push
#endif
#ifdef HAVE_PRAGMA_GCC_DIAGNOSTIC_IGNORED_COVERED_SWITCH_DEFAULT
# pragma GCC diagnostic ignored "-Wcovered-switch-default"
#endif
#ifdef HAVE_PRAGMA_GCC_DIAGNOSTIC_IGNORED_UNREACHABLE_CODE
# pragma GCC diagnostic ignored "-Wunreachable-code"
#endif
/* Older CLANG (e.g. clang-3.4) seems to not support the GCC pragmas above */
#ifdef __clang__
# pragma clang diagnostic push
# pragma clang diagnostic ignored "-Wunreachable-code"
# pragma clang diagnostic ignored "-Wcovered-switch-default"
#endif
                /* All enum cases defined as of the time of coding
                 * have been covered above. Handle later definitions,
                 * memory corruptions and buggy inputs below...
                 */
                default:
                        fatalx(EXIT_FAILURE, "no suitable definition found!");
#ifdef __clang__
# pragma clang diagnostic pop
#endif
#if (defined HAVE_PRAGMA_GCC_DIAGNOSTIC_PUSH_POP) \
 &amp;&amp; ( (defined HAVE_PRAGMA_GCC_DIAGNOSTIC_IGNORED_COVERED_SWITCH_DEFAULT) \
   || (defined HAVE_PRAGMA_GCC_DIAGNOSTIC_IGNORED_UNREACHABLE_CODE) )
# pragma GCC diagnostic pop
#endif</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_switch_case_fall_through"></a>Switch case fall-through</h4></div></div></div><p>While C standards allow to write <code class="literal">switch</code> statements to "fall through"
from handling one case into another, modern compilers frown upon that
practice and spew warnings which complicate detecting real bugs in the
code (and also looking back at some of the cases written decades ago,
it is not trivial to state whether the fall-through was intentional or
really is a bug).</p><p>Compilers which detect such problem usually offer ways to decorate the
code with comments or attributes to keep it quiet it in cases where the
jump is intentional; also C++17 introduces special keywords for that in
the standard. NUT aiming to be portable and independent of compilers as
much as possible, prefers the arguably clearer and standards-based way
of using <code class="literal">goto</code> into the next intended operation, even though it is a
couple of lines away, e.g.:</p><pre class="literallayout">int uppercase = 0;
switch (char_opt) {
        case 'U':
                uppercase = 1;
                goto fallthrough_case_u_option;
        case 'u':
        fallthrough_case_u_option:
                process_u_option(uppercase);
                break;
}</pre><p>In trivial cases, like falling through to <code class="literal">default</code> which just returns,
it may be clearer and more maintainable (adding other option cases in
the future) to just <code class="literal">return same_result</code> in the code block that would
fall through otherwise and avoid <code class="literal">goto</code> statements altogether.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_spaghetti"></a>Spaghetti</h4></div></div></div><p>If you use a <code class="literal">goto</code> that jumps over long distances (see "Switch case
fall-through" section above), expect us to drop it when our head stops
spinning. It gives us flashbacks to the very old code we wrote.
We’ve tried to clean up our act, and you should make the effort
as well.</p><p>We’re not making a blanket statement about gotos, since everything
probably has at least one good use.  There are a few cases where a goto
is more efficient than any other approach, but you probably won’t
encounter them very often in this software.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_legacy_code"></a>Legacy code</h4></div></div></div><p>There are parts of the source tree that do not yet conform to these
specs.  Part of this is due to the fact that the coding style has been
evolving slightly over the course of the project.  Some of the code you
see in these directories is 5 years old, and things have gotten cleaner
since then.  Don’t worry — it’ll get cleaned up the next time something
in the vicinity gets a visit.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_memory_leak_checking"></a>Memory leak checking</h4></div></div></div><p>We can’t say enough good things about valgrind.</p><p>If you do anything with dynamic memory in your code, you need to use this.
Just compile with <code class="literal">gcc -g</code> and start the program inside <code class="literal">valgrind</code>.
Run it through the suspected area and then exit cleanly.  Then valgrind
will tell you if you’ve done anything dodgy like freeing regions twice,
leaving files open, reading uninitialized memory, or if you’ve leaked
memory anywhere.</p><p>For NUT, there are prepared integrations like <code class="literal">configure --with-valgrind</code>.
See also <code class="literal">scripts/valgrind</code> in NUT sources for a helper tool and resource
files to suppress common third-party problems.</p><p>For more information, refer to the <a class="ulink" href="http://valgrind.kde.org" target="_top">Valgrind</a>
project.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_conclusion"></a>Conclusion</h4></div></div></div><p>The summary: please be kind to our eyes.  There’s a lot of stuff in here,
and many people have put a lot of time and energy to improve it.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_submitting_patches"></a>4.8. Submitting patches</h3></div></div></div><p>Current preference for suggesting changes is to open a pull request on
GitHub for the <a class="ulink" href="https://github.com/networkupstools/nut/" target="_top">https://github.com/networkupstools/nut/</a> project.</p><p>For some cases, small patches that arrive by mailing list in unified
format (<code class="literal">diff -Naur</code>) as plain text attachments with no HTML and a brief
summary at the top are easy to handle, but sadly also easy to overlook.</p><p>If a patch is sent to the nut-upsdev mailing list, it stands a better
chance of being seen immediately. However, it is likely to be dropped
if any issues cannot be resolved quickly. If your code might not work
for others, or if it is a large change, your best bet is to submit a
pull request or create an
<a class="ulink" href="https://github.com/networkupstools/nut/issues" target="_top">issue on GitHub</a>.</p><p>The issue tracker allows us to track the patches, and related discussion
for clarifications or a review process, over a longer period of time,
and it is less likely that a patch will fall through the cracks.
Posting a reminder to the developers (via the nut-upsdev list) about a
patch on GitHub is fair game, if the maintainers do not react in a few days.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_patch_cohesion"></a>4.9. Patch cohesion</h3></div></div></div><p>Patches should have some kind of unifying element.  One patch set is one
message, and it should all touch similar things.  If you have to edit 6
files to add support for neutrino detection in UPS hardware, that’s
fine.</p><p>However, sending one huge patch that does massive separate changes all over
the tree is not recommended.  That kind of patch has to be split up and
evaluated separately, assuming the core developers care enough to do that
instead of just dropping it.</p><p>If you have to make big changes in lots of places, send multiple
patches — one per item.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_the_finishing_touches_manual_pages_and_device_entry_in_hcl"></a>4.10. The finishing touches: manual pages and device entry in HCL</h3></div></div></div><p>If you change something that involves an argument to a program or
configuration file parsing, the man page is probably now out of date.
If you don’t update it, we have to, and we have enough to do as it is.</p><p>If you write a new driver, send in the man page when you send us the
source code for your driver.  Otherwise, we will be forced to write a
skeletal man page that will probably miss many of the finer points of
the driver and hardware.</p><p>The same remark goes for device entries: if you add support for new models,
please remember to also complete the hardware compatibility list, present
in <a class="ulink" href="data/driver.list.in" target="_top">data/driver.list.in</a>. This will be used to generate both textual,
static HTML and dynamic searchable HTML for the website.</p><p>Finally, don’t forget about fame and glory: if you added or substantially
updated a driver, your copyright belongs in the heading comment (along
with existing ones). For vendor backed (or sponsored) contributions we
welcome an entry in the <a class="ulink" href="docs/acknowledgements.txt" target="_top">docs/acknowledgements.txt</a> file as well,
to track and know the industry players who help make NUT better and more
useful.</p><p>It is nice to update the <a class="ulink" href="NEWS.adoc" target="_top">NEWS.adoc</a> file for significant development
to be seen as part of next release, as well as to update the
<a class="ulink" href="UPGRADING.adoc" target="_top">UPGRADING.adoc</a> file for potentially breaking changes and similar
heads-up notes for third-party teams (distribution packagers, clients
and bindings, etc.)</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_source_code_management"></a>4.11. Source code management</h3></div></div></div><p>We currently use a Git repository hosted at GitHub to track changes to
the NUT source code. This allows you to "fork" the repository (in GitHub
parlance), "clone" it to your workstation(s), make a new "branch" with
your changes, and post them back online for peer review prior to integration.</p><p>To obtain permission to commit directly to the common upstream NUT repository,
you must be prepared to spend a fair amount of time contributing to the
NUT codebase. Most developers will be well served by committing to their
own forked Git repository (preferably in a uniquely named branch for each
new contribution), and having the NUT team merge their changes using pull
requests.</p><p>Git offers a little more flexibility than the <code class="literal">svn update</code> command.
You may fetch other developers' changes into your repository, but hold
off on actually combining them with your branch until you have compared
the two branches (for instance, with <code class="literal">gitk --all</code>). Git also allows you
to accumulate more than one commit worth of changes before pushing to
another repository. This allows development to continue without a constant
network connection.</p><p>For a quick change to a file in the Git working copy, you can use
<code class="literal">git diff</code> to generate a patch to send to the nut-upsdev mailing list.
If you have more extensive changes, you can use <code class="literal">git format-patch</code> on
a complete commit or branch, and send the resulting series of patches
to the list.</p><p>If you use GitHub’s web-based editor to make changes, it tends to create
lots of small commits, one per change per file. Unless there is reason to
keep the intermediate history, we will probably collapse (or "squash" in
Git parlance) the entire branch into one commit with a <code class="literal">git rebase -i</code>
before merging.</p><p>The <a class="ulink" href="https://git.wiki.kernel.org/index.php/GitSvnCrashCourse" target="_top">GitSvnCrashCourse</a>
wiki page has some useful information for long-time users of Subversion.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_git_access"></a>Git access</h4></div></div></div><p>Anonymous Git checkouts are possible:</p><pre class="literallayout">:; git clone git://github.com/networkupstools/nut.git</pre><p>or</p><pre class="literallayout">:; git clone https://github.com/networkupstools/nut.git</pre><p>if it is necessary to get around a pesky firewall that blocks the native
Git protocol.</p><p>For a quicker checkout (when you don’t need the entire repository history),
you can limit the depth of the clone:</p><pre class="literallayout">:; git clone --depth 1 git://github.com/networkupstools/nut.git</pre><p>OPTIONALLY you can then fetch known git tags, so semantic versions look
better (based off a recent release, see
<a class="ulink" href="../developer-guide.chunked/index.html#versioning" target="_top">NUT Versioning</a> (or <code class="code">docs/nut-versioning.adoc</code> in NUT sources for up-to-date information)
for more details):</p><pre class="literallayout">:; cd nut
:; git fetch --tags --all</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_mercurial_hg_access"></a>Mercurial (hg) access</h4></div></div></div><p>There are those who prefer the simplicity and self-consistency of the
Mercurial SCM client over the hodgepodge of unique commands which make
up Git. Rather than debate the merits of each system, we will gently
guide you towards the <a class="ulink" href="http://hg-git.github.com/" target="_top">hg-git project</a>
which would theoretically be a transparent bridge between the central
Git repository, and your local Mercurial working copy.</p><p>Other tools for hg/git interoperability are sure to exist. We would
welcome any feedback about this process on the nut-upsdev mailing list.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_subversion_svn_access"></a>Subversion (SVN) access</h4></div></div></div><p>If you prefer to check out the NUT source code using an SVN client, GitHub
has a <a class="ulink" href="https://github.com/blog/966-improved-subversion-client-support" target="_top">SVN
interface to Git repositories</a> hosted on their servers. You can fork a copy
of the NUT repository and commit to your fork with SVN.</p><p>Be aware that the examples in the GitHub blog post might result in a
checkout that includes all of the current branches, as well as the trunk.
You are most likely interested in a command line similar to the following:</p><pre class="literallayout">:; svn co https://github.com/networkupstools/nut/trunk nut-trunk-svn</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ignoring_generated_files"></a>4.12. Ignoring generated files</h3></div></div></div><p>The NUT repository generally only holds files which are not generated from
other files. This prevents spurious differences from being recorded in the
repository history.</p><p>If you add a driver, it is recommended that you add the driver executable
name to the <code class="literal">.gitignore</code> file in that directory. Similarly, files generated
from <code class="literal">*.in</code> and <code class="literal">*.am</code> source templates should be ignored as well.
We try to include a number of generated files in the tarball releases with
<code class="literal">make dist</code> hooks in order to minimize the number of dependencies for end
users, but the assumption is that a developer can install the packages
needed to regenerate those files.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_commit_message_formatting"></a>4.13. Commit message formatting</h3></div></div></div><p>From the <code class="literal">git commit</code> man page:</p><div class="blockquote"><blockquote class="blockquote"><p>Though not required, it’s a good idea to begin the commit message with a
single short (less than 50 character) line summarizing the change, followed
by a blank line and then a more thorough description. The text up to the
first blank line in a commit message is treated as the commit title, and
that title is used throughout git.</p></blockquote></div><p>If your commit is just a change to one component, such as the HCL, upsd or a
specific driver, prefix your commit message in a way that matches similar
commits (typically with the file name(s), check <code class="literal">git log</code> for inspiration).
This helps when searching the repository or tracking down a regression.</p><p>Referring to previous commits can be tricky. If you are referring to the
immediate parent of a given commit, it suffices to say "the previous commit".
(Are you correcting a typo in the previous commit? If you haven’t pushed yet,
consider using the <code class="literal">git commit --amend</code> command instead of creating a new
commit.) For other commits, even though tools like gitk and GitHub’s
repository viewers recognize Git hashes and create links automatically, it is
best to add some context such as the commit title or a date.</p><p>You may notice that some older commits have <code class="literal">[[SVN:####]]</code> tags and Fossil-ID
footers. These were lifted from the old SVN commit messages using reposurgeon,
and should <span class="strong"><strong>not</strong></span> be used as a guide for future commits.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_commit_sign_off"></a>4.14. Commit sign-off</h3></div></div></div><p>Please also note that since 2023 we explicitly ask for contributions to be
"Signed Off" according to "Developer Certificate of Origin" as represented
in the <code class="literal">LICENSE-DCO</code> file in the root of NUT source tree (verbatim copy of
Version 1.1 of DCO published at <a class="ulink" href="https://developercertificate.org/" target="_top">https://developercertificate.org/</a> web site).
This is exactly the same one created and used by the Linux kernel developers.</p><p>This is a developer’s certification that he or she has the right to submit
the patch for inclusion into the project. Simply submitting a contribution
implies this agreement, however, please include a "Signed-off-by" tag in
every patch (this tag is a conventional way to confirm that you agree to
the DCO). In other words, this tag certifies that committer has the rights
to submit this work under the same license as the project and agrees to the
terms of a Developer Certificate of Origin.</p><p>Note that while git commit hook tricks are available to automatically sign
off all commits, these signatures are intended to be a conscious (legally
meaningful) act — hence they are not automated in git core with an easy
configuration option.</p><p>For more details see:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://github.com/networkupstools/nut/issues/1994" target="_top">https://github.com/networkupstools/nut/issues/1994</a>
</li><li class="listitem">
<a class="ulink" href="https://github.com/networkupstools/nut/wiki/Code-contributions,-PRs,-PGP-and-DCO" target="_top">https://github.com/networkupstools/nut/wiki/Code-contributions,-PRs,-PGP-and-DCO</a>
</li><li class="listitem">
<a class="ulink" href="https://stackoverflow.com/questions/1962094/what-is-the-sign-off-feature-in-git-for" target="_top">https://stackoverflow.com/questions/1962094/what-is-the-sign-off-feature-in-git-for</a>
</li><li class="listitem">
<a class="ulink" href="https://stackoverflow.com/questions/15015894/git-add-signed-off-by-line-using-format-signoff-not-working" target="_top">https://stackoverflow.com/questions/15015894/git-add-signed-off-by-line-using-format-signoff-not-working</a>
</li></ul></div><p>You are also encouraged to set up a PGP key, make its public part known, and
use it to sign your git commits (in addition to the <code class="literal">Signed-Off-By</code> tag) by
also passing a <code class="literal">-S</code> option or calling <code class="literal">git config commit.gpgsign true</code> once.
Numerous public articles can walk you through this ordeal, including:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://docs.github.com/en/authentication/managing-commit-signature-verification/signing-commits" target="_top">https://docs.github.com/en/authentication/managing-commit-signature-verification/signing-commits</a>
</li><li class="listitem">
<a class="ulink" href="https://docs.github.com/en/authentication/managing-commit-signature-verification/telling-git-about-your-signing-key" target="_top">https://docs.github.com/en/authentication/managing-commit-signature-verification/telling-git-about-your-signing-key</a>
</li><li class="listitem">
<a class="ulink" href="https://www.kernel.org/doc/html/v4.19/process/maintainer-pgp-guide.html" target="_top">https://www.kernel.org/doc/html/v4.19/process/maintainer-pgp-guide.html</a>
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_repository_etiquette_and_quality_assurance"></a>4.15. Repository etiquette and quality assurance</h3></div></div></div><p>For developers who have commit access to the common upstream NUT repository:
Please keep the Git "master" branch in working condition at all times.
The "master" branch may be used to generate daily tarballs, it provides the
baseline for new contributions, and occasionally is tagged for a new release.
It should not contain broken code. If you need to commit incremental changes
that leave the system in a broken state, please do so in a separate branch
and merge the changes back into "master" once they are complete.</p><p>To help keep the codebase ever-green, we run a number of CI tests and builds
in various conditions, including older compilers, different C/C++ standard
revisions, and an assortment of operating systems; a section below elaborates
on this in more detail.</p><p>You are encouraged to use <code class="literal">git rebase -i</code> on your private Git branches to
separate your changes into <a class="link" href="developers.html#_patch_cohesion" title="4.9. Patch cohesion">logical changes</a>.</p><p>From there, you can generate patches for the issue tracker, or the nut-upsdev
mailing list.</p><p>Note that once you rebase a branch, anyone else who has a copy of this branch
will need to rebase on top of your rebased branch. Obviously, this hinders
collaboration. In this case, we recommend that you rebase only in your private
repository, and push when things are ready for discussion. Merging instead of
rebasing will help with collaboration, but please do not turn the repository
history into a pile of spaghetti by merging unnecessarily. (Test merges can be
done on integration branches, which can be discarded if the merge is trivial.)
Be sure that your commit messages are descriptive when merging.</p><p>If you haven’t created a commit out of your local changes yet, and you want to
fetch the latest code, you can also use <code class="literal">git stash</code> before pulling, then <code class="literal">git
stash pop</code> to apply your saved changes.</p><p>Here is an example workflow (using a slightly older <code class="literal">git</code> command-line syntax,
so it works verbatim on more platforms):</p><pre class="screen">        :; git clone -o central git://github.com/networkupstools/nut.git

        :; cd nut
        :; git remote add -f USERNAME git://github.com/USERNAME/nut.git

        ### OPTIONALLY you can then fetch known git tags, so semantic
        ### versions look better (based off a recent release):
        :; git fetch --tags --all

        :; git checkout master
        :; git branch my-new-feature
        :; git checkout my-new-feature

        # Hack away

        :; git add changed-file.c
        :; git commit -s

        # Fix a typo in a file or commit message:

        :; git commit -s -a --amend

        # Someone committed something to the central repository. Fetch it.

        :; git fetch central
        :; git rebase central/master

        # Publish your branch to your GitHub repository:

        :; git push USERNAME my-new-feature</pre><p>If you are new to Git, but are familiar with SVN, some of the following links
may be of use:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://web.archive.org/web/20191224210950/https://git-scm.com/course/svn.html" target="_top">Git - SVN Crash Course (archived)</a>
</li><li class="listitem">
<a class="ulink" href="https://git-scm.com/book/en/v2/Git-and-Other-Systems-Migrating-to-Git" target="_top">Git and Other Systems - Migrating to Git</a>
</li><li class="listitem">
<a class="ulink" href="https://www.git-tower.com/learn/git/ebook/en/command-line/appendix/from-subversion-to-git" target="_top">Switching from Subversion to Git</a>
</li><li class="listitem">
<a class="ulink" href="https://www.atlassian.com/git/tutorials/migrating-overview" target="_top">Migrate from SVN to Git</a>
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="building"></a>4.16. Building the Code</h3></div></div></div><p>For a developer, the NUT build process starts with <code class="literal">./autogen.sh</code>.</p><p>This script generates the <code class="literal">./configure</code> script that end users typically
invoke to build NUT. If you are making a number of changes to the NUT
source tree, configuring with the <code class="literal">--enable-maintainer-mode</code> flag will
ensure that after you change a <code class="literal">Makefile.am</code>, nearby <code class="literal">Makefile.in</code> and
<code class="literal">Makefile</code> get regenerated. At a minimum, you will need at least:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
autoconf
</li><li class="listitem">
automake
</li><li class="listitem">
libtool
</li><li class="listitem">
Python
</li><li class="listitem">
Perl
</li></ul></div><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>See <a class="ulink" href="../qa-guide.chunked/index.html#NUT_Config_Prereqs" target="_top">Prerequisites for building NUT on different OSes</a> (or <code class="code">docs/config-prereqs.txt</code> in NUT sources for up-to-date information) for better detailed
package lists for different operating systems.</p><p>See <code class="literal">ci_build.sh</code> for automating many practical scenarios, for easier
iterations.</p><p>It is optional, but highly recommended, to have Python 2.x or 3.x, and Perl,
to generate some files included into the <code class="literal">configure</code> script whose presence
is checked by autotools when it is generated. Neutered files can be just
"touched" to pass the <code class="literal">autogen.sh</code> if these interpreters are not available,
and effectively skip those parts of the build later on — <code class="literal">autogen.sh</code> will
then advise which special environment variables to <code class="literal">export</code> in your situation
and re-run it.</p></div><p>Even if you do not use your distribution’s packages of NUT, installing the
distribution’s list of build dependencies for NUT can reduce the amount of
trial-and-error when installing dependencies. For instance, in Debian, you
can run <code class="literal">apt-get build-dep nut</code> to install all of the auto* tools as well
as any development libraries and headers — as known for the version of NUT
packaged with the OS distribution release you are using.</p><p>After running <code class="literal">./autogen.sh</code>, you can pass your local configuration
options to <code class="literal">./configure</code> and run <code class="literal">make</code> from the top-level directory.
To avoid the need for root privileges when testing new NUT code, you
may wish to use <code class="literal">--prefix=$HOME/local/nut --with-statepath=/tmp</code>.
You can also keep compilation times down by only building the driver
which you are currently working on: <code class="literal">--with-drivers=driver1,dummy-ups</code>.</p><p>Before pushing your commits upstream, please run <code class="literal">make distcheck-light</code>.
This checks that the Makefiles are not broken, that all the relevant files
are distributed, and that there are no compilation or installation errors.
Note that unless you specifically pass <code class="literal">--with-doc=skip</code> to <code class="literal">configure</code>,
this requires all of the dependencies necessary to build the documentation
to be locally installed on your system, including <code class="literal">asciidoc</code>, <code class="literal">a2x</code>,
<code class="literal">xsltproc</code>, <code class="literal">dblatex</code> and any additional XSL stylesheets.</p><p>Running <code class="literal">make distcheck-light</code> is especially important if you have added or
removed files, or updated <code class="literal">configure.ac</code> or some <code class="literal">Makefile.am</code> file.
Remember: simply adding a file to Git does not mean it will be distributed.
To distribute a file, you must update the corresponding <code class="literal">Makefile.am</code> with
<code class="literal">EXTRA_DIST</code> entry and possibly other recipe handling.</p><p>There is also <code class="literal">make distcheck</code>, which runs an even stricter set of
tests than <code class="literal">make distcheck-light</code>, but will not work unless you have all
of the optional third-party libraries and features installed.</p><p>Finally note, that since 2017 the GitHub upstream project was monitored
by Travis CI (in addition to earlier multi-platform buildbots which
occasionally did not work), replaced since 2021 by a dedicated NUT CI farm
and a number of free cloud CI resources to test some 200-300 scenarios
with different combinations of build environments and tooling implementations.</p><p>This means that if your posted improvements are based on current NUT
"master" branch, the resulting pull request should get tested for a number of
scenarios automatically. If your code adds a substantial feature, consider
extending the <code class="literal">Jenkinsfile-dynamatrix</code> and/or <code class="literal">ci_build.sh</code> scripts in the
workspace root to add another <code class="literal">BUILD_TYPE</code> to the matrix of tests run in
parallel.</p></div></div><div xmlns="" class="navfooter nut_footer"><hr />
		Last updated 2025-09-06 19:11:31 -- Network UPS Tools 2.8.4.42</div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="versioning.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="new-drivers.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top"> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div></body></html>