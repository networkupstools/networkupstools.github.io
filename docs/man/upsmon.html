<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 10.2.0" />
<title>UPSMON(8)</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
<meta name="format-detection" content="telephone=no" />
</head>
<body class="article">
<div id="header">
<h1>UPSMON(8)</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_name">NAME</h2>
<div class="sectionbody">
<div class="paragraph"><p>upsmon - UPS monitor and shutdown controller</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_synopsis">SYNOPSIS</h2>
<div class="sectionbody">
<div class="paragraph"><p><strong>upsmon</strong> -h</p></div>
<div class="paragraph"><p><strong>upsmon</strong> -c <em>command</em> [-P <em>pid</em>]</p></div>
<div class="paragraph"><p><strong>upsmon</strong> [-D] [-F | -B] [-K] [-p] [-u <em>user</em>]</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_description">DESCRIPTION</h2>
<div class="sectionbody">
<div class="paragraph"><p><strong>upsmon</strong> is the client process that is responsible for the most important part
of UPS monitoring&#8201;&#8212;&#8201;shutting down the system when the power goes out.  It
can call out to other helper programs for notification purposes during
power events.</p></div>
<div class="paragraph"><p>upsmon can monitor multiple systems using a single process.  Every UPS
that is defined in the <a href="upsmon.conf.html">upsmon.conf(5)</a> configuration file is assigned
a power value and a type (<strong>primary</strong> or <strong>secondary</strong>).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_options">OPTIONS</h2>
<div class="sectionbody">
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>-c</strong> <em>command</em>
</dt>
<dd>
<p>
Send the command <em>command</em> to the existing upsmon process.  Valid
commands are:
</p>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>fsd</strong>
</dt>
<dd>
<p>
shutdown all primary-mode UPSes (use with caution)
</p>
</dd>
<dt class="hdlist1">
<strong>stop</strong>
</dt>
<dd>
<p>
stop monitoring and exit
</p>
</dd>
<dt class="hdlist1">
<strong>reload</strong>
</dt>
<dd>
<p>
reread <a href="upsmon.conf.html">upsmon.conf(5)</a> configuration file.  See
"reloading nuances" below if this doesn&#8217;t work.
</p>
</dd>
</dl></div>
</dd>
<dt class="hdlist1">
<strong>-P</strong> <em>pid</em>
</dt>
<dd>
<p>
Send the command signal above using specified PID number, rather than
consulting the PID file.  This can help define service units which
start main <code>upsmon</code> as a foreground process so it does not have to
rely on a PID file.
</p>
</dd>
<dt class="hdlist1">
<strong>-D</strong>
</dt>
<dd>
<p>
Raise the debugging level.  upsmon will run in the foreground by default,
and will print information on stdout about the monitoring process.
Use this option multiple times for more details.
</p>
</dd>
<dt class="hdlist1">
<strong>-F</strong>
</dt>
<dd>
<p>
upsmon will run in the foreground, regardless of debugging settings.
</p>
</dd>
<dt class="hdlist1">
<strong>-B</strong>
</dt>
<dd>
<p>
upsmon will run in the background, regardless of debugging settings.
</p>
</dd>
<dt class="hdlist1">
<strong>-K</strong>
</dt>
<dd>
<p>
Test for the shutdown flag.  If it exists and contains the magic string
from upsmon, then upsmon will exit with <code>EXIT_SUCCESS</code>.  Any other condition
will make upsmon exit with <code>EXIT_FAILURE</code>.
</p>
<div class="paragraph"><p>You can test for a successful exit from <code>upsmon -K</code> in your shutdown
scripts to know when to call <a href="upsdrvctl.html">upsdrvctl(8)</a> to shut down the UPS.</p></div>
</dd>
<dt class="hdlist1">
<strong>-p</strong>
</dt>
<dd>
<p>
Run privileged all the time.  Normally upsmon will split into two
processes.  The majority of the code runs as an unprivileged user, and
only a tiny stub runs as <code>root</code> to eventually call <code>SHUTDOWNCMD</code> if needed.
This switch will disable that mode, and run the old "all root all the time"
system.
</p>
<div class="paragraph"><p>This is not the recommended mode, and you should not use this unless you
have a very good reason.</p></div>
</dd>
<dt class="hdlist1">
<strong>-u</strong> <em>user</em>
</dt>
<dd>
<p>
Set the user for the unprivileged monitoring process.  This has no effect
when using <em>-p</em>.
</p>
<div class="paragraph"><p>The default <em>user</em> is set at build configuration time with
<code>configure --with-user=...</code>.  Typically this is <em>nobody</em> (if not
otherwise configured), which is far from ideal, so most packaged
distributions will probably have a specific <em>nut</em> user for this task.
If your notification scripts need to run as a specific user, set it here.</p></div>
<div class="paragraph"><p>You can also set this in the <a href="upsmon.conf.html">upsmon.conf(5)</a> file with the
<code>RUN_AS_USER</code> directive.</p></div>
</dd>
</dl></div>
</div>
</div>
<div class="sect1">
<h2 id="_common_options">COMMON OPTIONS</h2>
<div class="sectionbody">
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>-h</strong>
</dt>
<dd>
<p>
Show the command-line help message.
</p>
</dd>
<dt class="hdlist1">
<strong>-V</strong>
</dt>
<dd>
<p>
Show NUT version banner.  More details may be available if you also
<code>export NUT_DEBUG_LEVEL=1</code> or greater verbosity level.
</p>
</dd>
<dt class="hdlist1">
<strong>-W</strong> <em>secs</em>
</dt>
<dd>
<p>
Set the timeout for initial network connections (by default they are
indefinitely non-blocking, or until the system interrupts the attempt).
Overrides the optional <code>NUT_DEFAULT_CONNECT_TIMEOUT</code> environment variable.
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect1">
<h2 id="_ups_definitions">UPS DEFINITIONS</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the <a href="upsmon.conf.html">upsmon.conf(5)</a>, you must specify at least one UPS that will
be monitored.  Use the MONITOR directive like this:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>MONITOR 'system' 'powervalue' 'username' 'password' 'type'</code></pre>
</div></div>
<div class="paragraph"><p>The <em>system</em> refers to a <a href="upsd.html">upsd(8)</a> server, in the form
<code>upsname[@hostname[:port]]</code>.  The default <em>hostname</em> is "localhost",
and default <em>port</em> is <em>3493</em>.  Some examples follow:</p></div>
<div class="ulist"><ul>
<li>
<p>
"su700@mybox" means a UPS called "su700" on a system called "mybox".
This is the normal form.
</p>
</li>
<li>
<p>
"fenton@bigbox:5678" is a UPS called "fenton" on a system called
"bigbox" which runs <a href="upsd.html">upsd(8)</a> on port "5678".
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <em>powervalue</em> refers to how many power supplies on this client system are
being driven this UPS.  This is typically set to <em>1</em>, but see the section
on power values below.</p></div>
<div class="paragraph"><p>The <em>username</em> is a section in your <a href="upsd.users.html">upsd.users(5)</a> file.
Whatever password you set in that section must match the <em>password</em>
set in this file for the corresponding data server instance.</p></div>
<div class="paragraph"><p>The type set in that section of the data server configuration must also match
the <em>type</em> here&#8201;&#8212;&#8201;<strong>primary</strong> or <strong>secondary</strong> (consider it an "upsmon role").
In general, a "primary" client process is one running on the system with the
UPS actually plugged into a serial or USB port, and a "secondary" is drawing
power from the UPS but can&#8217;t talk to it directly.
See the section on UPS types for more.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_notify_events">NOTIFY EVENTS</h2>
<div class="sectionbody">
<div class="paragraph"><p><strong>upsmon</strong> senses several events as it monitors each UPS.  They are called
"notify events", as they can be used to tell the users and admins about the
change in status.  See the additional NOTIFY-related sections below for
information on customizing the delivery of these messages.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>ONLINE</strong>
</dt>
<dd>
<p>
The UPS is back on line.
</p>
</dd>
<dt class="hdlist1">
<strong>ONBATT</strong>
</dt>
<dd>
<p>
The UPS is on battery.
</p>
</dd>
<dt class="hdlist1">
<strong>LOWBATT</strong>
</dt>
<dd>
<p>
The UPS battery is low (as determined by the driver).
</p>
</dd>
<dt class="hdlist1">
<strong>FSD</strong>
</dt>
<dd>
<p>
The UPS has been commanded into the "forced shutdown" mode.
</p>
</dd>
<dt class="hdlist1">
<strong>COMMOK</strong>
</dt>
<dd>
<p>
Communication with the UPS has been established.
</p>
</dd>
<dt class="hdlist1">
<strong>COMMBAD</strong>
</dt>
<dd>
<p>
Communication with the UPS was just lost.
</p>
</dd>
<dt class="hdlist1">
<strong>SHUTDOWN</strong>
</dt>
<dd>
<p>
The local system is being shut down.
</p>
</dd>
<dt class="hdlist1">
<strong>REPLBATT</strong>
</dt>
<dd>
<p>
The UPS needs to have its battery replaced.
</p>
</dd>
<dt class="hdlist1">
<strong>NOCOMM</strong>
</dt>
<dd>
<p>
The UPS can&#8217;t be contacted for monitoring.
</p>
</dd>
<dt class="hdlist1">
<strong>NOPARENT</strong>
</dt>
<dd>
<p>
<code>upsmon</code> parent process died - shutdown impossible.
</p>
</dd>
<dt class="hdlist1">
<strong>CAL</strong>
</dt>
<dd>
<p>
UPS calibration in progress.
</p>
</dd>
<dt class="hdlist1">
<strong>NOTCAL</strong>
</dt>
<dd>
<p>
UPS calibration finished.
</p>
</dd>
<dt class="hdlist1">
<strong>OFF</strong>
</dt>
<dd>
<p>
UPS administratively OFF or asleep.
</p>
</dd>
<dt class="hdlist1">
<strong>NOTOFF</strong>
</dt>
<dd>
<p>
UPS no longer administratively OFF or asleep.
</p>
</dd>
<dt class="hdlist1">
<strong>BYPASS</strong>
</dt>
<dd>
<p>
UPS on bypass (powered, not protecting).
</p>
</dd>
<dt class="hdlist1">
<strong>NOTBYPASS</strong>
</dt>
<dd>
<p>
UPS no longer on bypass.
</p>
</dd>
<dt class="hdlist1">
<strong>ECO</strong>
</dt>
<dd>
<p>
UPS in ECO or similar mode (as defined and named by vendor); other
names include High Efficiency mode and Energy Saver System.
</p>
<div class="paragraph"><p>For example, Eaton docs define High Efficiency mode as a sort of
hardware-monitored bypass with switch-over under 10ms into Online
mode in case of troubles (so what was known as Line-Interactive
in the older days), which can be <strong>chosen</strong> instead of always running
in a dual-conversion mode (safer, but more wasteful and with a toll
on battery life). Older devices only implemented one or the other.</p></div>
</dd>
<dt class="hdlist1">
<strong>NOTECO</strong>
</dt>
<dd>
<p>
UPS no longer in ECO mode (see above).
</p>
</dd>
<dt class="hdlist1">
<strong>ALARM</strong>
</dt>
<dd>
<p>
UPS has one or more active alarms (look at <code>ups.alarm</code> for details).
</p>
</dd>
<dt class="hdlist1">
<strong>NOTALARM</strong>
</dt>
<dd>
<p>
UPS is no longer in an alarm state (no active alarms).
</p>
</dd>
<dt class="hdlist1">
<strong>OVER</strong>
</dt>
<dd>
<p>
UPS is overloaded.
</p>
</dd>
<dt class="hdlist1">
<strong>NOTOVER</strong>
</dt>
<dd>
<p>
UPS is no longer overloaded.
</p>
</dd>
<dt class="hdlist1">
<strong>TRIM</strong>
</dt>
<dd>
<p>
UPS is trimming incoming voltage.
</p>
</dd>
<dt class="hdlist1">
<strong>NOTTRIM</strong>
</dt>
<dd>
<p>
UPS is no longer trimming incoming voltage.
</p>
</dd>
<dt class="hdlist1">
<strong>BOOST</strong>
</dt>
<dd>
<p>
UPS is boosting incoming voltage.
</p>
</dd>
<dt class="hdlist1">
<strong>NOTBOOST</strong>
</dt>
<dd>
<p>
UPS is no longer boosting incoming voltage.
</p>
</dd>
<dt class="hdlist1">
<strong>OTHER</strong>
</dt>
<dd>
<p>
UPS has at least one unclassified status token.
</p>
</dd>
<dt class="hdlist1">
<strong>NOTOTHER</strong>
</dt>
<dd>
<p>
UPS has no unclassified status tokens anymore.
</p>
</dd>
<dt class="hdlist1">
<strong>SUSPEND_STARTING</strong>
</dt>
<dd>
<p>
OS is entering sleep/suspend/hibernate mode.
</p>
</dd>
<dt class="hdlist1">
<strong>SUSPEND_FINISHED</strong>
</dt>
<dd>
<p>
OS just finished sleep/suspend/hibernate mode, de-activating
obsolete UPS readings to avoid an unfortunate shutdown.
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect1">
<h2 id="_notify_command">NOTIFY COMMAND</h2>
<div class="sectionbody">
<div class="paragraph"><p>In <a href="upsmon.conf.html">upsmon.conf(5)</a>, you can configure a program called the NOTIFYCMD
that will handle events that occur.</p></div>
<div class="paragraph"><p>The syntax is: <code>NOTIFYCMD</code> "<em>path to program</em>"</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>NOTIFYCMD "/usr/local/bin/notifyme"</code>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Remember to wrap the path in "double quotes" if it contains any spaces.
It should probably not rely on receiving any command-line arguments.</p></div>
<div class="paragraph"><p>The program you run as your NOTIFYCMD can use the environment variables
NOTIFYTYPE and UPSNAME to know what has happened and on which UPS.  It
also receives the notification message (see below) as the first (and
only) argument, so you can deliver a pre-formatted message too.</p></div>
<div class="paragraph"><p>Note that the NOTIFYCMD will only be called for a given event when you set
the EXEC flag by using the notify flags, as detailed below.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_notify_flags">NOTIFY FLAGS</h2>
<div class="sectionbody">
<div class="paragraph"><p>By default, all notify events (see above) generate a global message
(wall) to all users, plus they are logged via the syslog.
Except for Windows where upsmon only writes to the syslog by default.
You can change this with the NOTIFYFLAG directive in the configuration file:</p></div>
<div class="paragraph"><p>The syntax is: <code>NOTIFYFLAG</code> <em>notifytype</em> <em>flags</em></p></div>
<div class="paragraph"><p>Examples:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>NOTIFYFLAG ONLINE SYSLOG</code>
</p>
</li>
<li>
<p>
<code>NOTIFYFLAG ONBATT SYSLOG+WALL</code>
</p>
</li>
<li>
<p>
<code>NOTIFYFLAG LOWBATT SYSLOG+WALL+EXEC</code>
</p>
</li>
</ul></div>
<div class="paragraph"><p>The flags that can be set on a given notify event are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>SYSLOG</strong>
</dt>
<dd>
<p>
Write this message to the syslog.
</p>
</dd>
<dt class="hdlist1">
<strong>WALL</strong>
</dt>
<dd>
<p>
Send this message to all users on the system via <a href="https://linux.die.net/man/1/wall">wall(1)</a>.
</p>
</dd>
<dt class="hdlist1">
<strong>EXEC</strong>
</dt>
<dd>
<p>
Execute the NOTIFYCMD.
</p>
</dd>
<dt class="hdlist1">
<strong>IGNORE</strong>
</dt>
<dd>
<p>
Don&#8217;t do anything.  If you use this, don&#8217;t use any of the other flags.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>You can mix these flags; for example,  <code>SYSLOG+WALL+EXEC</code> does all three
for a given event.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_notify_messages">NOTIFY MESSAGES</h2>
<div class="sectionbody">
<div class="paragraph"><p>upsmon comes with default messages for each of the NOTIFY events.  These
can be changed with the NOTIFYMSG directive.</p></div>
<div class="paragraph"><p>The syntax is: <code>NOTIFYMSG</code> <em>type</em> "<em>message</em>"</p></div>
<div class="paragraph"><p>Examples:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>NOTIFYMSG ONLINE "UPS %s is getting line power"</code>
</p>
</li>
<li>
<p>
<code>NOTIFYMSG ONBATT "Someone pulled the plug on %s"</code>
</p>
</li>
</ul></div>
<div class="paragraph"><p>The first instance of <code>%s</code> is replaced with the identifier of the UPS that
generated the event.  These messages are used when sending walls to the
users directly from upsmon, and are also passed to the NOTIFYCMD.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Certain notifications, such as <code>NOTIFY_ALARM</code> and <code>NOTIFY_OTHER</code>,
can accept a second instance of <code>%s</code> that would be replaced with the
alarm text or the unrecognized token, respectively.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_power_values">POWER VALUES</h2>
<div class="sectionbody">
<div class="paragraph"><p>The "current overall power value" is the sum of all UPSes that are
currently able to supply power to the system hosting upsmon.  Any
UPS that is either on line or just on battery contributes to this
number.  If a UPS is critical (on battery and low battery) or has been
put into "forced shutdown" mode, it no longer contributes.</p></div>
<div class="paragraph"><p>The syntax is: <code>MONITOR</code> <em>upsname</em> <em>powervalue</em> <em>username</em> <em>password</em> <em>type</em></p></div>
<div class="paragraph"><p>A "power value" on a MONITOR line in the config file is the number of
power supplies that the UPS runs on the current system.</p></div>
<div class="ulist"><ul>
<li>
<p>
Normally, you only have one power supply, so it will be set to <em>1</em>.
</p>
<div class="paragraph"><p>Example:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>MONITOR myups@myhost 1 username mypassword primary</code>
</p>
</li>
</ul></div>
</li>
<li>
<p>
On a large server with redundant power supplies, the power value for a UPS
may be greater than 1.  You may also have more than one of them defined.
</p>
<div class="paragraph"><p>Examples for a server with four power supply modules and two UPSes (each
feeding two power supplies of that server):</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>MONITOR ups-alpha@myhost 2 username mypassword primary</code>
</p>
</li>
<li>
<p>
<code>MONITOR ups-beta@myhost 2 username mypassword primary</code>
</p>
</li>
</ul></div>
</li>
<li>
<p>
You can also set the power value for a UPS to <em>0</em> if it does not supply any
power to that system.  This is generally used when you want to use the
upsmon notification features for a UPS even though it&#8217;s not actually
powering the system that hosts this instance of the upsmon client.
</p>
<div class="paragraph"><p>Don&#8217;t set this to "primary" unless you really want to power this UPS off
when this instance of upsmon needs to shut down for its own reasons.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>MONITOR faraway@anotherbox 0 username mypassword secondary</code>
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>The "minimum power value" is the number of power supplies that must be
receiving power in order to keep this <code>upsmon</code> client&#8217;s computer running.</p></div>
<div class="paragraph"><p>The syntax is: <code>MINSUPPLIES</code> <em>value</em></p></div>
<div class="ulist"><ul>
<li>
<p>
Typical PCs only have 1, so most users will leave this at the default.
</p>
<div class="paragraph"><p>Example:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>MINSUPPLIES 1</code>
</p>
</li>
</ul></div>
</li>
<li>
<p>
If you have a server or similar system with redundant power, then this
value will usually be set higher.  One that requires three power supplies
out of 4 to be running at all times would simply set it to 3.
</p>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>Example:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>MINSUPPLIES 3</code>
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>When the current overall healthy UPS-protected external power value drops
below the minimum required power value, <code>upsmon</code> starts the shutdown sequence.
This design allows you to lose some of your power supplies in a redundant
power environment without bringing down the entire system, while still
working properly for smaller systems.</p></div>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_ups_connection_types_and_upsmon_roles">UPS CONNECTION TYPES AND UPSMON ROLES</h2>
<div class="sectionbody">
<div class="paragraph"><p><strong>upsmon</strong> and <a href="upsd.html">upsd(8)</a> don&#8217;t always run on the same system.  When they
do, any UPSes that are directly attached to that upsmon host should be
monitored in "primary" mode, which makes that upsmon instance take charge
of that equipment, and it will wait for the "secondary" systems to disconnect
before shutting down the local system.  This allows the distant systems (just
monitoring over the network) to shut down cleanly before <code>upsdrvctl shutdown</code>
runs locally on the primary system and turns them all off.</p></div>
<div class="paragraph"><p>When upsmon runs as a secondary, it is relying on the distant system to tell
it about the state of the UPS.  When that UPS goes critical (on battery
and low battery), it immediately invokes the local shutdown command.  This
needs to happen quickly.  Once all secondaries disconnect from the distant
<a href="upsd.html">upsd(8)</a> server, its primary-mode upsmon will start its own shutdown
process.  Your secondary systems must all quiesce and shut down before the
primary turns off the shared power source, or filesystem damage may result.</p></div>
<div class="paragraph"><p>upsmon deals with secondaries that get wedged, hang, or otherwise fail to
gracefully disconnect from <a href="upsd.html">upsd(8)</a> in a timely manner with the
HOSTSYNC timer.  During a shutdown situation, the primary upsmon will give
up after this interval and it will shut down anyway.  This keeps the primary
from sitting there forever (which would endanger that host) if a secondary
should break somehow.  This defaults to 15 seconds.</p></div>
<div class="paragraph"><p>If your primary system is shutting down too quickly, set the FINALDELAY
interval to something greater than the default 15 seconds.  Don&#8217;t set
this too high, or your UPS battery may run out of power before the
primary upsmon process shuts down that system. If you do need more time,
consider starting the shutdown after a short time on battery, for details
see the Timed Shutdowns section.</p></div>
<div class="paragraph"><p>For a more technical take, please see the Shutdown Activity Workflow section.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_timed_shutdowns">TIMED SHUTDOWNS</h2>
<div class="sectionbody">
<div class="paragraph"><p>For those rare situations where the shutdown process can&#8217;t be completed
between the time that low battery is signalled and the UPS actually powers
off the load, use the <a href="upssched.html">upssched(8)</a> helper program.  You can use it
along with upsmon to schedule a shutdown based on the "on battery" event.
upssched can then come back to upsmon to initiate the shutdown once it has
run on battery too long.</p></div>
<div class="paragraph"><p>This can be complicated and messy, so stick to the default critical UPS
handling if you can.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_redundant_power_supplies">REDUNDANT POWER SUPPLIES</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you have more than one power supply for redundant power, you may also
have more than one UPS feeding your computer.  upsmon can handle this.  Be
sure to set the UPS power values appropriately and the MINSUPPLIES value
high enough so that it keeps running until it really does need to shut
down.</p></div>
<div class="paragraph"><p>For example, the HP NetServer LH4 by default has 3 power supplies
installed, with one bay empty.  It has two power cords, one per side of
the box.  This means that one power cord powers two power supply bays,
and that you can only have two UPSes supplying power.</p></div>
<div class="paragraph"><p>Connect UPS "alpha" to the cord feeding two power supplies, and UPS
"beta" to the cord that feeds the third and the empty slot.  Define alpha
as a powervalue of 2, and beta as a powervalue of 1.  Set the MINSUPPLIES
to 2.</p></div>
<div class="paragraph"><p>When alpha goes on battery, your current overall power value will stay
at 3, as it&#8217;s still supplying power.  However, once it goes critical (on
battery and low battery), it will stop contributing to the current overall
power value.  That means the value will be 1 (beta alone), which is less
than 2.  That is insufficient to run the system, and upsmon will invoke
the shutdown sequence.</p></div>
<div class="paragraph"><p>However, if beta goes critical, subtracting its contribution will take the
current overall value from 3 to 2.  This is just high enough to satisfy
the minimum, so the system will continue running as before.  If beta
returns later, it will be re-added and the current value will go back to
3.  This allows you to swap out UPSes, change a power configuration, or
whatever, as long as you maintain the minimum power value at all times.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_mixed_operations">MIXED OPERATIONS</h2>
<div class="sectionbody">
<div class="paragraph"><p>Besides being able to monitor multiple UPSes, upsmon can also monitor them
as different roles.  If you have a system with multiple power supplies
serviced by separate UPS batteries, it&#8217;s possible to be a primary on one
UPS and a secondary on the other.  This usually happens when you run
out of serial or USB ports and need to do the monitoring through another
system nearby.</p></div>
<div class="paragraph"><p>This is also complicated, especially when it comes time to power down a
UPS that has gone critical but doesn&#8217;t supply the local system.  You can
do this with some scripting magic in your notify command script, but it&#8217;s
beyond the scope of this manual.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_forced_shutdowns">FORCED SHUTDOWNS</h2>
<div class="sectionbody">
<div class="paragraph"><p>When upsmon is forced to bring down the local system, it sets the
"FSD" (forced shutdown) flag on any UPSes that it is running in primary
mode.  This is used to synchronize secondary systems in the event that
a primary which is otherwise OK needs to be brought down due to some
pressing event on the UPS manager system.</p></div>
<div class="paragraph"><p>You can manually invoke this mode on the system with primary-mode upsmon
by starting another copy of the program with <code>-c fsd</code> command line argument.
This is useful when you want to initiate a shutdown before the critical
stage through some external means, such as <a href="upssched.html">upssched(8)</a>.</p></div>
<div class="paragraph"><p>For a more technical take, please see the Shutdown Activity Workflow section.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Please note that by design, since we require power-cycling the
load and don&#8217;t want some systems to be powered off while others remain
running if the "wall power" returns at the wrong moment as usual, the "FSD"
flag can not be removed from the data server unless its daemon is restarted.
If we do take the first step in critical mode, then we normally intend to go
all the way&#8201;&#8212;&#8201;shut down all the servers gracefully, and power down the UPS.</td>
</tr></table>
</div>
<div class="paragraph"><p>Keep in mind that some UPS devices and corresponding drivers would also latch
or otherwise resurface the "FSD" state again even if "wall power" is available,
but the remaining battery charge is below a threshold configured as "safe" in
the device (usually if you manually power on the UPS after a long power outage).
This is by design of respective UPS vendors, since in such situation they
can not guarantee that if a new power outage happens, their UPS would safely
shut down your systems again. So it is deemed better and safer to stay dark
until batteries become sufficiently charged.</p></div>
<div class="paragraph"><p>When it is time to shut down, upsmon creates POWERDOWNFLAG to
communicate to the operating system that the UPS should be commanded
off late in the shutdown sequence.  This file is removed if present
when upsmon starts, so that the next normal shutdown does not cause
the UPS to be turned off.  (The file can&#8217;t in general be removed
during shutdown because the filesystem might be read only.  If the
file is in a RAM-backed filesystem, the it won&#8217;t be present and the
check to remove it won&#8217;t fire.)</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_simulating_power_failures">SIMULATING POWER FAILURES</h2>
<div class="sectionbody">
<div class="paragraph"><p>To test a synchronized shutdown without pulling the plug on your UPS(es),
you need only set the forced shutdown (FSD) flag on them.  You can do this
by calling upsmon again to set the flag, i.e.:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>:; upsmon -c fsd</code></pre>
</div></div>
<div class="paragraph"><p>After that, the primary and the secondary will do their usual shutdown
sequence as if the battery had gone critical, while you can time how long
it takes for them.  This is much easier on your UPS equipment, and it beats
crawling under a desk to find the plug.</p></div>
<div class="paragraph"><p>Note you can also use a dummy SHUTDOWNCMD setting to just report that the
systems would shut down at this point, without actually disrupting their work.</p></div>
<div class="paragraph"><p>For inspiration, you can see the setup done by the NUT Integration Tests suite
under the <code>tests/NIT</code> directory in NUT sources, including references to the
shutdown and notification scripts which only log the activity (you may have
to configure at least a trivial NUT build and run <code>make check-NIT-sandbox</code> to
generate some of the configuration files&#8201;&#8212;&#8201;or inspect the <code>nit.sh</code> script
which pieces them together). Notably, see <code>scripts/misc/notifyme-debug</code> as
not only a logger, but optionally a wrapper for <code>upssched</code> (in test runs),
and <code>clients/upssched-cmd</code> as a sample implementation of an <a href="upssched.html">upssched(8)</a>
<code>CMDSCRIPT</code> which also focuses on logging.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">After such "dummy" experiments you may have to restart the NUT data
server <code>upsd</code> to clear its "FSD" flag for the devices and clients involved,
and make sure no files named by <code>POWERDOWNFLAG</code> option (e.g. <code>/etc/killpower</code>)
remain on the <code>upsmon primary</code> systems under test.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_shutdown_activity_workflow">SHUTDOWN ACTIVITY WORKFLOW</h2>
<div class="sectionbody">
<div class="paragraph"><p>Looking into <code>clients/upsmon.c</code> sources as the ultimate authority, you
can find that the chain of events during a forced shutdown is. This can
help make sense of the timing variables involved, and notifications sent
(which you may want to handle, perhaps with <a href="upssched.html">upssched(8)</a>):</p></div>
<div class="ulist"><ul>
<li>
<p>
The path to shutdown activity of a host starts when its locally running
  <code>upsmon</code> client (in any role) decides the power situation is critical,
  e.g. by having too few "healthy" power supplies in a real outage, and/or
  by seeing <code>FSD</code> among <code>ups.status</code> tokens&#8201;&#8212;&#8201;possibly still "latched" in
  the <code>upsd</code> data server while you start a new <code>upsmon</code> instance, or when
  you call <code>upsmon -c fsd</code> on that system to simulate the outage;
</p>
</li>
<li>
<p>
Such <code>upsmon</code> instance ends up in <code>forceshutdown()</code> method;
</p>
</li>
<li>
<p>
There it loops over all UPSes it <code>MONITOR`s as a `primary</code>, and calls the
  <code>setfsd()</code> method for each (causing a local <code>FSD</code> notification, if one was
  not sent earlier);
</p>
</li>
<li>
<p>
If there were no such UPSes&#8201;&#8212;&#8201;we are a secondary, and go into <code>doshutdown()</code>
  method immediately
</p>
</li>
<li>
<p>
Otherwise we are a primary, and only go into <code>doshutdown()</code> method after
  first completing the <code>sync_secondaries()</code> method, which:
</p>
</li>
<li>
<p>
runs an infinite loop until either there are no other persistent clients
    logged on to the data server (<code>upsd</code>) for each UPS we are a primary for,
    or until <code>HOSTSYNC</code> timeout elapses;
</p>
</li>
<li>
<p>
it should issue a <code>SHUTDOWN_HOSTSYNC</code> notification if it is going to wait
    at all (if there were other clients seen on first loop cycle).
</p>
</li>
<li>
<p>
Finally, in the <code>doshutdown()</code> method, it:
</p>
</li>
<li>
<p>
issues a <code>SHUTDOWN</code> notification;
</p>
</li>
<li>
<p>
waits for <code>FINALDELAY</code>;
</p>
</li>
<li>
<p>
starts the timer for <code>SHUTDOWNEXIT</code> (which may be used to force <code>upsmon</code>
    process to linger after calling <code>SHUTDOWNCMD</code>&#8201;&#8212;&#8201;e.g. can be used by a
    secondary to block the primary from cutting power too early for some use
    cases, like safely parking some external machinery);
</p>
</li>
<li>
<p>
calls the <code>SHUTDOWNCMD</code> (either directly in mono-process mode, or by
    telling the <code>root</code>-privileged part to do so in the common case);
</p>
</li>
<li>
<p>
optionally linger, if <code>SHUTDOWNEXIT</code> is so configured;
</p>
</li>
<li>
<p>
ultimately exit the daemon (also causes the <code>root</code>-privileged part to exit,
    by breaking the communications pipe between them).
</p>
</li>
</ul></div>
<div class="paragraph"><p>Note that if your <code>upsmon</code> does split into privileged and unprivileged parts,
all notifications run in the unprivileged context (your handling scripts may
have to <code>sudo</code> explicitly if/when/where you want to do something to the system).
Only <code>SHUTDOWNCMD</code> is called in privileged context.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_dead_upses">DEAD UPSES</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the event that upsmon can&#8217;t reach <a href="upsd.html">upsd(8)</a>, it declares that UPS
"dead" after some interval controlled by DEADTIME in the
<a href="upsmon.conf.html">upsmon.conf(5)</a>.  If this happens while that UPS was last known to be
on battery, it is assumed to have gone critical and no longer contributes
to the overall power value.</p></div>
<div class="paragraph"><p>upsmon will alert you to a UPS that can&#8217;t be contacted for monitoring
with a "NOCOMM" notifier by default every 300 seconds.  This can be
changed with the NOCOMMWARNTIME setting.</p></div>
<div class="paragraph"><p>Also upsmon normally reports polling failures for each device that are in place
for each POLLFREQ loop (e.g. "Data stale" or "Driver not connected") to
system log as configured.  If your devices are expected to be AWOL for an
extended timeframe, you can use POLLFAIL_LOG_THROTTLE_MAX to reduce the
stress on syslog traffic and storage, by posting these messages only once
in every several loop cycles, and when the error condition has changed or
cleared.  A negative value means standard behavior (log on every loop,
effectively same as when <code>max=1</code>), and a zero value means to never repeat
the message (log only on start and end/change of the failure state).</p></div>
<div class="paragraph"><p>Note that this throttle only applies to one latest-active error state per
monitored device.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_ups_alarms">UPS ALARMS</h2>
<div class="sectionbody">
<div class="paragraph"><p>UPS manufacturers and UPS drivers may implement device-specific alarms to
notify the user about potentially severe conditions of the UPS. The status
"ALARM" will be set on such UPS as a common denominator for the different
implementations throughout the various UPS drivers and generally anytime
that a "ups.alarm" variable is seen reported by the specific UPS driver.</p></div>
<div class="paragraph"><p>Alarms can be acted upon by the user using the "ALARM" and "NOTALARM" notifiers,
which are reported by the <code>upsmon</code> when the "ALARM" status occurs or disappears.</p></div>
<div class="paragraph"><p>As alarms raised by the UPS are usually severe in nature, the <code>upsmon</code> watches
a UPS in such a state more closely, bumping up the polling frequency as needed.</p></div>
<div class="paragraph"><p>When connection loss occurs in such an alarm state, the <code>upsmon</code> will by default
consider the volatile UPS as critical/dead and this may lead to false shutdowns
if the actual alarm was in fact mundane in nature (e.g. caused by a HE/ECO mode).
This can be changed by utilizing the <code>ALARMCRITICAL</code> setting within <code>upsmon.conf</code>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_reloading_nuances">RELOADING NUANCES</h2>
<div class="sectionbody">
<div class="paragraph"><p>upsmon usually gives up root powers for the process that does most of
the work, including handling signals like SIGHUP to reload the configuration
file.  This means your <a href="upsmon.conf.html">upsmon.conf(5)</a> file must be readable by
the non-root account that upsmon switches to.</p></div>
<div class="paragraph"><p>If you want reloads to work, upsmon must run as some user that has
permissions to read the configuration file.  We recommend making a new
user just for this purpose, as making the file readable by "nobody"
(the default user) would be a bad idea; packages typically ship with
a <code>nut</code> or <code>ups</code> user to run NUT daemon services.</p></div>
<div class="paragraph"><p>See the <code>RUN_AS_USER</code> section in <a href="upsmon.conf.html">upsmon.conf(5)</a> for more on this topic.</p></div>
<div class="paragraph"><p>Additionally, you can&#8217;t change the <code>SHUTDOWNCMD</code> or <code>POWERDOWNFLAG</code>
definitions with a reload due to the split-process model.  If you change
those values, you <strong>must</strong> stop upsmon and start it back up.  upsmon
will warn you in the syslog if you make changes to either of those
values during a reload.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_environment_variables">ENVIRONMENT VARIABLES</h2>
<div class="sectionbody">
<div class="paragraph"><p><strong>NUT_DEBUG_LEVEL</strong> sets default debug verbosity if no <strong>-D</strong> arguments
were provided on command line, but does not request that the daemon
runs in foreground mode.</p></div>
<div class="paragraph"><p><strong>NUT_CONFPATH</strong> is the path name of the directory that contains
<code>upsmon.conf</code> and other configuration files.  If this variable is not set,
<strong>upsmon</strong> uses a built-in default, which is often <code>/usr/local/ups/etc</code>.</p></div>
<div class="paragraph"><p><strong>NUT_QUIET_INIT_UPSNOTIFY=true</strong> can be used to prevent daemons which can
notify service management frameworks (such as systemd) about passing
their lifecycle milestones from emitting such notifications (including
those about lack of system support for such modern features, once per run).</p></div>
<div class="paragraph"><p><strong>NUT_QUIET_INIT_BANNER=true</strong> can be used to suppress NUT tool name and
version banner. NOT recommended for services due to adverse troubleshooting
impact, but may be helpful in shell profiles or scripts which process NUT
tool outputs.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_files">FILES</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="upsmon.conf.html">upsmon.conf(5)</a></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_see_also">SEE ALSO</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_server">Server:</h3>
<div class="paragraph"><p><a href="upsd.html">upsd(8)</a></p></div>
</div>
<div class="sect2">
<h3 id="_clients">Clients:</h3>
<div class="paragraph"><p><a href="upsc.html">upsc(8)</a>, <a href="upscmd.html">upscmd(8)</a>,
<a href="upsrw.html">upsrw(8)</a>, <a href="upsmon.html">upsmon(8)</a></p></div>
</div>
<div class="sect2">
<h3 id="_cgi_programs">CGI programs:</h3>
<div class="paragraph"><p><a href="upsset.cgi.html">upsset.cgi(8)</a>, <a href="upsstats.cgi.html">upsstats.cgi(8)</a>, <a href="upsimage.cgi.html">upsimage.cgi(8)</a></p></div>
</div>
<div class="sect2">
<h3 id="_internet_resources">Internet resources:</h3>
<div class="paragraph"><p>The NUT (Network UPS Tools) home page: <a href="https://www.networkupstools.org/">https://www.networkupstools.org/</a></p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2025-10-08 14:46:22 UTC -- Network UPS Tools 2.8.4.272
</div>
</div>
</body>
</html>
